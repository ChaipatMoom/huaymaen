<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢ ‚Äî Lucky Aura Edition</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ============================
        CSS ‚Äî TONAL MOO + AURA
       ============================ -->
  <style>

:root {
  --bg: #0f0e17;
  --card: rgba(255,255,255,0.08);
  --accent1: #a855f7;
  --accent2: #7c3aed;
  --accent3: #9f67ff;
  --gold: #facc15;
  --text: #f1f1f1;
  --muted: #b5b5b5;
  --glow: rgba(168,85,247,0.55);
}

/* Background */
body.bg-moon {
  background: radial-gradient(circle at top, #1d1633 0%, #0d0b15 70%);
  font-family:'Prompt',sans-serif;
  color: var(--text);
  -webkit-font-smoothing:antialiased;
}

/* ============================
      CARD
   ============================ */
.card {
  background: var(--card);
  border-radius: 14px;
  backdrop-filter: blur(10px);
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 0 30px rgba(0,0,0,0.45);
  transition: 0.25s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 32px rgba(168,85,247,0.22);
}

/* ============================
      AURA CARD (AI ZONE)
   ============================ */
.aura-card {
  background: linear-gradient(135deg,#4c1d95,#7c3aed);
  box-shadow: 0 0 28px rgba(124,58,237,0.8);
  position: relative;
  overflow:hidden;
  border-radius:12px;
}

.aura-card::after {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.05)
  );
  animation: auraRotate 6s linear infinite;
  opacity:0.22;
  pointer-events:none;
}

@keyframes auraRotate {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

/* ============================
      AURA BOUNCE MODAL
   ============================ */
.modal-aura {
  animation: auraPop 0.55s cubic-bezier(.25,1.8,.5,1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(168,85,247,0.55);
  border-radius: 18px;
}

@keyframes auraPop {
  0% {
    transform: scale(0.55) rotate(-4deg);
    opacity: 0;
    filter: blur(20px);
  }
  60% {
    transform: scale(1.08) rotate(2deg);
    opacity: 1;
    filter: blur(0);
  }
  100% {
    transform: scale(1);
    rotate: 0deg;
  }
}

/* swirling aura */
.modal-aura::before {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    transparent 0%,
    rgba(168,85,247,0.25) 10%,
    transparent 35%,
    rgba(255,255,255,0.1) 50%,
    rgba(168,85,247,0.22) 70%,
    transparent 100%
  );
  animation: swirlAura 8s linear infinite;
  opacity:0.45;
  pointer-events:none;
}
@keyframes swirlAura {
  to { transform: rotate(360deg); }
}

/* ============================
      BUTTON PRIMARY
   ============================ */
.btn-primary {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: white;
  padding: 11px 18px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 0 14px var(--glow);
  transition: 0.15s;
}
.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 22px var(--glow);
}

/* ============================
      INPUT / SELECT
   ============================ */
.input-dd {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text);
  border-radius:10px;
  padding: 8px 10px;
}
.input-dd:focus {
  outline:none;
  border-color: var(--accent2);
  box-shadow:0 0 10px var(--glow);
}

/* ============================
      CUSTOM DROPDOWN
   ============================ */
.dd-btn {
  background: rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.18);
  padding:8px 14px;
  color:white;
  border-radius: 10px;
  font-weight: 600;
  min-width:130px;
  transition:0.2s;
}
.dd-btn:hover {
  box-shadow:0 0 15px var(--glow);
}

.dd-menu {
  position:absolute;
  right:0;
  margin-top:8px;
  background: rgba(22,17,38,0.95);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 25px rgba(0,0,0,0.4);
  z-index:50;
  width:180px;
  padding:6px 0;
  animation:fadeSlide 0.25s ease;
}
.dd-item {
  padding:10px 14px;
  color:white;
  cursor:pointer;
  font-weight:500;
  transition:0.18s;
  display:flex;
  gap:6px;
  align-items:center;
}
.dd-item:hover {
  background: rgba(255,255,255,0.12);
  padding-left:20px;
}

/* ============================
      RESULT CARD
   ============================ */
.result-card {
  border-radius:14px;
  padding:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(8px);
  transition:0.2s;
}
.result-card:hover {
  transform:translateY(-4px);
  box-shadow:0 0 26px rgba(124,58,237,0.4);
}

/* ============================
      MODAL BACKDROP
   ============================ */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:100;
}

/* ============================
      SIMPLE SPINNER
   ============================ */
.ai-spinner {
  width:30px;
  height:30px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,0.25);
  border-top-color: var(--gold);
  animation: spin 1s linear infinite;
  margin:auto;
}
@keyframes spin {
  to { transform:rotate(360deg); }
}

/* small util classes used later */
.text-gold { color: var(--gold); }
.muted { color: rgba(255,255,255,0.6); font-size:13px; }

/* ============================
      RESPONSIVE IMPROVEMENTS
   ============================ */

/* Mobile-first base adjustments */
body.bg-moon {
  min-height: 100vh;
  padding-bottom: 20px;
}

/* Mobile: Reduce padding and font sizes */
@media (max-width: 640px) {
  .btn-primary {
    padding: 10px 14px;
    font-size: 13px;
  }
  
  .card {
    padding: 12px;
    border-radius: 10px;
  }
  
  .aura-card {
    padding: 16px 12px !important;
  }
  
  .dd-btn {
    min-width: 100px;
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .input-dd {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 10px 8px;
  }
  
  h1 { font-size: 24px !important; }
  h2 { font-size: 18px !important; }
  h3 { font-size: 16px !important; }
}

/* Tablet: Moderate adjustments */
@media (min-width: 641px) and (max-width: 1024px) {
  .btn-primary { padding: 10px 16px; font-size: 14px; }
  .card { padding: 14px; }
  .input-dd { font-size: 14px; }
}

/* Desktop: Full optimizations */
@media (min-width: 1025px) {
  .btn-primary { padding: 11px 18px; font-size: 14px; }
  .card { padding: 16px; }
  .aura-card { padding: 24px !important; }
  .dd-btn { min-width: 140px; }
}

/* Header responsiveness */
@media (max-width: 768px) {
  .header-container { flex-wrap: wrap; gap: 12px; }
  .header-left { width: 100%; margin-bottom: 8px; }
  .header-right { width: 100%; justify-content: flex-start; }
}

/* Stat Grid */
@media (max-width: 640px) { .stat-grid { grid-template-columns: 1fr; } }
@media (min-width: 641px) and (max-width: 1024px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1025px) { .stat-grid { grid-template-columns: repeat(3, 1fr); } }

/* Result Grid */
@media (max-width: 640px) { .result-grid { grid-template-columns: 1fr; } }
@media (min-width: 641px) and (max-width: 1024px) { .result-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1025px) { .result-grid { grid-template-columns: repeat(3, 1fr); } }

/* AI Result grid */
@media (max-width: 640px) {
  .ai-result-grid { grid-template-columns: 1fr; gap: 12px; }
  .ai-result-grid .card > div:first-child { font-size: 11px; }
}
@media (min-width: 641px) and (max-width: 1024px) {
  .ai-result-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (min-width: 1025px) {
  .ai-result-grid { grid-template-columns: repeat(4, 1fr); }
}

/* Modal responsiveness */
@media (max-width: 640px) {
  .modal { padding: 16px; }
  .modal-aura { max-width: 90vw; max-height: 90vh; overflow-y: auto; }
}

/* Simulator grid removed */

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .btn-primary, .dd-btn, .dd-item {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }
  .input-dd { min-height: 44px; font-size: 16px; }
  .card:hover { transform: none; }
  .result-card:hover { transform: none; }
}

  </style>
</head>

<body class="bg-moon">

  <!-- ONBOARDING MODAL (PART 1 includes markup) -->
  <div id="onboard" class="modal hidden">
    <div class="modal-aura p-8 max-w-md w-full text-center text-white">
      <h1 class="text-3xl font-bold mb-2">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‚ú®</h1>
      <p class="text-white/70 mb-6">
        ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏ß‡∏¢ AI <br>
        ‡∏£‡∏∏‡πà‡∏ô Lucky Aura ‚Äî Ensemble by Chaipat
      </p>

      <div class="text-left mb-6 space-y-2 text-white/80">
        <div>üîÆ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏ö‡∏ö Ensemble Boost</div>
        <div>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏•‡∏±‡∏ö</div>
        <div>üé≤ Lucky 2 ‡∏ï‡∏±‡∏ß / 3 ‡∏ï‡∏±‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏° % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</div>
        <div>üèÜ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      </div>

      <button onclick="closeOnboard()" class="btn-primary w-full py-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <!-- ADD RESULT MODAL -->
  <div id="addModal" class="modal hidden">
    <div class="modal-aura max-w-md w-full p-6 text-white">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</h2>
        <button onclick="closeAddModal()" class="text-red-300 text-lg">‚úï</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
          <input id="dateInput" type="date" class="input-dd w-full" />
        </div>

        <div>
          <label class="text-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <div class="grid grid-cols-3 gap-2">
            <button id="typeTHBtn" class="dd-btn w-full" onclick="setAddType('TH')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
            <button id="typeLAOBtn" class="dd-btn w-full" onclick="setAddType('LAO')">üá±üá¶ ‡∏•‡∏≤‡∏ß</button>
            <button id="typeHANOIBtn" class="dd-btn w-full" onclick="setAddType('HANOI')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</button>
          </div>
        </div>

        <div>
          <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</label>
          <input id="firstPrizeInput" type="text" maxlength="6" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 461252" />
        </div>

        <div>
          <label class="text-sm">3 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label>
          <div class="grid grid-cols-2 gap-2">
            <input id="threeBottomAInput" type="text" maxlength="3" class="input-dd w-full text-center" placeholder="‡πÄ‡∏ä‡πà‡∏ô 137" />
            <input id="threeBottomBInput" type="text" maxlength="3" class="input-dd w-full text-center" placeholder="‡πÄ‡∏ä‡πà‡∏ô 995" />
          </div>
        </div>

        <div>
          <label class="text-sm">2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label>
          <input id="twoBottomInput" type="text" maxlength="2" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 22" />
        </div>
      </div>

      <div class="mt-6">
        <button onclick="saveResult()" class="btn-primary w-full py-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- HEADER / TOP -->
  <div class="max-w-6xl mx-auto px-4 py-3 sm:py-4 header-container flex items-center justify-between">
    <div class="header-left flex items-center gap-2 sm:gap-3">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 0 18px var(--glow);">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2l2.6 5.8L21 9l-4.5 3.3L17.2 20 12 16.9 6.8 20l.7-7.7L3 9l6.4-1.2L12 2z"/></svg>
      </div>
      <div>
        <div class="text-lg sm:text-xl font-bold text-gold">AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡πÜ</div>
        <div class="muted text-xs">Ai ¬∑ Ensemble by Chaipat</div>
      </div>
    </div>

    <div class="header-right flex items-center gap-2 sm:gap-3">
      <button onclick="openAddModal()" class="btn-primary hidden sm:flex items-center gap-2">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 5v14m7-7H5" stroke="white" stroke-width="2"/></svg>
        <span class="hidden sm:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>
      </button>
      
      <button onclick="openAddModal()" class="btn-primary sm:hidden px-3">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 5v14m7-7H5" stroke="white" stroke-width="2"/></svg>
      </button>

      <!-- dropdown trigger -->
      <div class="relative">
        <button onclick="toggleDD()" class="dd-btn flex items-center gap-1 sm:gap-2">
          <span id="ddFlag">üáπüá≠</span>
          <span id="ddLabel" class="hidden sm:inline">‡πÑ‡∏ó‡∏¢</span>
        </button>

        <div id="ddMenu" class="dd-menu hidden">
          <div class="dd-item" onclick="setDD('‡πÑ‡∏ó‡∏¢','üáπüá≠')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</div>
          <div class="dd-item" onclick="setDD('‡∏•‡∏≤‡∏ß','üá±üá¶')">üá±üá¶ ‡∏•‡∏≤‡∏ß</div>
          <div class="dd-item" onclick="setDD('‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢','üáªüá≥')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI AURA CARD -->
  <div class="max-w-6xl mx-auto px-4 mt-3 sm:mt-4">
    <div class="aura-card p-4 sm:p-6 mt-3 sm:mt-4">
      <h2 class="text-base sm:text-lg font-bold text-white mb-3">üåü ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á AI ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ</h2>

      <div id="aiLoading" class="hidden text-center my-4 sm:my-6">
        <div class="ai-spinner"></div>
        <p class="text-white/60 mt-2 text-xs sm:text-sm">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î!...</p>
      </div>

      <div id="aiResult" class="ai-result-grid grid gap-3 sm:gap-4 text-white">
        <div class="card">
          <div class="text-xs sm:text-sm muted">üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 </div>
          <div id="aiSix" class="text-xl sm:text-2xl font-bold mt-1">‚Äî</div>
        </div>

        <div class="card">
          <div class="text-xs sm:text-sm muted">üéØ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</div>
          <div id="aiTop3" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
        </div>

        <div class="card">
          <div class="text-xs sm:text-sm muted">üé≤ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß</div>
          <div id="aiBottom3" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
        </div>

        <div class="card">
    <div class="text-xs sm:text-sm muted">‚ú® ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</div>
    <div id="aiTwo" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
    <div class="text-xs muted mt-2">Confidence: <span id="aiScore">‚Äî%</span></div>
  </div>
</div>
<button onclick="runAIwithAura()" class="btn-primary w-full mt-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>

  <!-- ===============================
       MAIN CONTENT
       =============================== -->
  <main class="max-w-6xl mx-auto px-4 mt-6 sm:mt-8">

    <!-- STAT CARDS -->
    <section class="stat-grid grid gap-4 sm:gap-6 mb-8 sm:mb-10">

      <!-- Frequent 2 Digits -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üî• ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
        <div id="freq2" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <!-- Pie Chart -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">‚öñÔ∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 vs ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß</h3>
        <canvas id="pieChart" height="160"></canvas>
      </div>

      <!-- AI Aura Summary -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üîÆ ‡∏™‡∏£‡∏∏‡∏õ AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡πÜ</h3>

        <div class="text-sm text-white/70 space-y-1">
          <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1:  
            <span id="aiSix_small" class="text-gold font-bold"></span>
          </div>
          <div>‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1: <span id="aiTop3_small" class="text-gold"></span></div>
          <div>‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß: <span id="aiBottom3_small" class="text-gold"></span></div>
          <div>‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: <span id="aiTwo_small" class="text-gold"></span></div>
          <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <span id="aiScore_small" class="text-gold font-bold"></span></div>
        </div>
      </div>

    </section>


    <!-- ===============================
         RESULT HISTORY
         =============================== -->
    <section class="card mb-10">
      <div class="flex justify-between items-center mb-4">

        <div>
          <h2 class="text-xl font-bold text-white">üóÇÔ∏è ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
          <div class="text-xs text-white/60">‡πÅ‡∏™‡∏î‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 12 ‡∏á‡∏ß‡∏î</div>
        </div>

        <!-- Dropdown Filter -->
        <div class="relative">
          <button id="ddBtnHistory" onclick="toggleDDHistory()" class="dd-btn flex items-center gap-2">
            <span id="ddHistoryFlag">üåê</span>
            <span id="ddHistoryLabel">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
          </button>

          <div id="ddHistoryMenu" class="dd-menu hidden">
            <div class="dd-item" onclick="setHistoryFilter('all','üåê','‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">üåê ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="dd-item" onclick="setHistoryFilter('TH','üáπüá≠','‡πÑ‡∏ó‡∏¢')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</div>
            <div class="dd-item" onclick="setHistoryFilter('LAO','üá±üá¶','‡∏•‡∏≤‡∏ß')">üá±üá¶ ‡∏•‡∏≤‡∏ß</div>
            <div class="dd-item" onclick="setHistoryFilter('HANOI','üáªüá≥','‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</div>
          </div>
        </div>

      </div>

      <!-- History List -->
      <div id="historyList" class="result-grid grid gap-3 sm:gap-4"></div>
    </section>



    

  </main>
<script>


/* ============================

   Firebase config & init

   ============================ */

const firebaseConfig = {

  apiKey:"AIzaSyCkS6eu3SuB5McIkS_7J8srMIhXQ7osc-E",

  authDomain:"huaymaen-lottoai.firebaseapp.com",

  databaseURL:"https://huaymaen-lottoai-default-rtdb.asia-southeast1.firebasedatabase.app",

  projectId:"huaymaen-lottoai",

  storageBucket:"huaymaen-lottoai.firebasestorage.app",

  messagingSenderId:"326340239586",

  appId:"1:326340239586:web:563d03ca906ca4ba327ebb",

  measurementId:"G-MF97ZM968E"

};

firebase.initializeApp(firebaseConfig);

const db = firebase.database().ref("lottery");


/* ============================

   Load data from Firebase

   ============================ */

db.on('value', (snap) => {

  allData = [];

  if(snap.val()){

    Object.values(snap.val()).forEach(r => allData.push(r));

    allData.sort((a,b)=> b.date.localeCompare(a.date));

  }

  renderHistory();

  updateStats();

});


/* ============================

   Global state

   ============================ */

let allData = [];          // raw data from firebase
let historyFilter = 'all'; // 'all'|'‡πÑ‡∏ó‡∏¢'|'‡∏•‡∏≤‡∏ß'|'‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'
let pieChart = null;

let addType = 'TH';
function setAddType(t){
  addType = t;
  const ids = {TH:'typeTHBtn', LAO:'typeLAOBtn', HANOI:'typeHANOIBtn'};
  ['typeTHBtn','typeLAOBtn','typeHANOIBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove('btn-primary'); el.classList.add('dd-btn'); }
  });
  const el = document.getElementById(ids[t]);
  if(el){ el.classList.remove('dd-btn'); el.classList.add('btn-primary'); }
}
function typeToLabel(t){
  if(t==='TH') return '‡πÑ‡∏ó‡∏¢';
  if(t==='LAO') return '‡∏•‡∏≤‡∏ß';
  if(t==='HANOI') return '‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢';
  return t;
}

/* ======= small utils ======= */
const pad = (s,n=2)=>String(s||'').padStart(n,'0');
const isDigits = s => /^\d+$/.test(String(s||''));

/* ============================
   ONBOARDING (open once)
   ============================ */
function openOnboard(){ document.getElementById('onboard').classList.remove('hidden'); }
function closeOnboard(){
  document.getElementById('onboard').classList.add('hidden');
  localStorage.setItem('lg_onboard_done','yes');
}
(function maybeOpenOnboard(){
  setTimeout(openOnboard, 700);
})();

/* ============================
   ADD RESULT MODAL controls
   ============================ */
function openAddModal(){ document.getElementById('addModal').classList.remove('hidden'); }
function closeAddModal(){
  document.getElementById('addModal').classList.add('hidden');
  // clear fields
  const ids = ['dateInput','firstPrizeInput','threeBottomAInput','threeBottomBInput','twoBottomInput'];
  ids.forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
  setAddType('TH');
}

/* ============================
   Header dropdown (flag)
   ============================ */
function toggleDD(){
  const menu = document.getElementById('ddMenu');
  if(menu) menu.classList.toggle('hidden');
}
function setDD(label, flag){
  const lbl = document.getElementById('ddLabel');
  const f = document.getElementById('ddFlag');
  if(lbl) lbl.innerText = label;
  if(f) f.innerText = flag;
  // no immediate filtering required here (this is visual header)
  // close menu
  const menu = document.getElementById('ddMenu'); if(menu) menu.classList.add('hidden');
}

/* ============================
   History dropdown filter
   ============================ */
function toggleDDHistory(){
  const m = document.getElementById('ddHistoryMenu');
  if(m) m.classList.toggle('hidden');
}
function setHistoryFilter(key, flag, label){
  historyFilter = key; // use key directly ('‡πÑ‡∏ó‡∏¢'/'‡∏•‡∏≤‡∏ß'/'‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'/'all')
  const lbl = document.getElementById('ddHistoryLabel');
  const f = document.getElementById('ddHistoryFlag');
  if(lbl) lbl.innerText = label;
  if(f) f.innerText = flag;
  const m = document.getElementById('ddHistoryMenu'); if(m) m.classList.add('hidden');
  renderHistory(); // re-render with filter
}



/* ============================
   Helper: check duplicate by date+type
   ============================ */
function hasDuplicate(dateStr, typeStr){
  return allData.some(r => String(r.date) === String(dateStr) && String(r.type) === String(typeStr));
}

/* ============================
   Save result from Add Modal
   - validate fields
   - prevent duplicate date+type
   - push to firebase
   - clear & close
   - trigger AI run + effects
   ============================ */
async function saveResult(){
  const dateVal = document.getElementById('dateInput').value;
  const full6 = (document.getElementById('firstPrizeInput').value||'').trim();
  const threeA = (document.getElementById('threeBottomAInput').value||'').trim();
  const threeB = (document.getElementById('threeBottomBInput').value||'').trim();
  const two = (document.getElementById('twoBottomInput').value||'').trim();

  if(!dateVal || !full6 || !two){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1 , ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß , ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß)');
    return;
  }
  if(!isDigits(full6) || full6.length !== 6){
    alert('‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }
  if(!isDigits(threeA) || threeA.length !== 3){
    alert('‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }
  if(!isDigits(two) || two.length !== 2){
    alert('‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }

  const dnum = dateVal.replace(/-/g,'');
  const type = addType;

  // allow duplicate save if same date+type exists

  // 3 ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á (optional, sanitize to 3 digits or '---')
  let bottomA='---', bottomB='---';
  if(isDigits(threeA) && threeA.length===3) bottomA = threeA;
  if(isDigits(threeB) && threeB.length===3) bottomB = threeB;

  const payload = {
    date: dnum,
    type: type,
    full6: pad(full6,6),
    lower3a: bottomA,
    lower3b: bottomB,
    bottom: pad(two,2)
  };

  const typeLabel = typeToLabel(type);
  const confirmMsg = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateVal}\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1: ${full6}\n‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß: ${bottomA}${bottomB!=='---'?`, ${bottomB}`:''}\n‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: ${two}`;
  const ok = confirm(confirmMsg);
  if(!ok) return;

  try {
    const key = `${type}_${dnum}`;
    await db.child(key).set(payload);
    // close + clear
    closeAddModal();
  } catch (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Firebase.');
  }
}



/* ============================
   Firebase listener -> keep allData up-to-date
   ============================ */
// handled above (single listener)

/* ============================
   Render history (cards)
   - respect historyFilter
   - latest 12 entries
   ============================ */
function renderHistory(){
  const box = document.getElementById('historyList');
  if(!box) return;
  
  let arr = allData.slice();

  const is3 = s => /^\d{3}$/.test(String(s||''));
  const is2 = s => /^\d{2}$/.test(String(s||''));
  const byKey = new Map();
  arr.forEach(r => {
    const key = r.date + '|' + r.type;
    const score = (is3(r.lower3a)?1:0) + (is3(r.lower3b)?1:0) + (is2(r.bottom)?1:0) + (String(r.full6||'').length===6?1:0);
    const exist = byKey.get(key);
    if(!exist || score > exist._score) { r._score = score; byKey.set(key, r); }
  });
  arr = Array.from(byKey.values());
  arr.sort((a,b)=> b.date.localeCompare(a.date));

  // Apply type filter (only if not 'all')
  if(historyFilter && historyFilter !== 'all'){
    arr = arr.filter(r => {
      const t = String(r.type).trim();
      if(historyFilter==='TH') return t==='TH' || t==='‡πÑ‡∏ó‡∏¢';
      if(historyFilter==='LAO') return t==='LAO' || t==='‡∏•‡∏≤‡∏ß';
      if(historyFilter==='HANOI') return t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢';
      return true;
    });
  }

  arr = arr.slice(0, 12);

  if(arr.length === 0){
    box.innerHTML = `<div class="text-white/60 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    return;
  }

  box.innerHTML = arr.map(r => {
    const top3 = (r.full6 && r.full6.length === 6) ? r.full6.slice(-3) : '-';
    const lower = [r.lower3a, r.lower3b].filter(x => x && x !== '---').join(", ") || '-';
    const flag = (r.type === 'TH' || r.type==='‡πÑ‡∏ó‡∏¢') ? 'üáπüá≠'
      : (r.type==='LAO' || r.type==='‡∏•‡∏≤‡∏ß') ? 'üá±üá¶'
      : (r.type==='HANOI' || r.type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') ? 'üáªüá≥' : 'üåê';
    const typeLabel = r.type === 'TH' ? '‡πÑ‡∏ó‡∏¢' : r.type === 'LAO' ? '‡∏•‡∏≤‡∏ß' : r.type === 'HANOI' ? '‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢' : r.type;

    const dateFmt = `${r.date.slice(6,8)}/${r.date.slice(4,6)}/${r.date.slice(0,4)}`;

    return `
      <div class="result-card p-4" data-date="${r.date}" data-type="${r.type}" data-full6="${r.full6||''}" data-lower3a="${r.lower3a||''}" data-lower3b="${r.lower3b||''}" data-bottom="${r.bottom||''}">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm text-white/70">${flag} <span class="font-semibold ml-1">${typeLabel}</span></div>
          <div class="text-xs text-yellow-300">üìÖ ${dateFmt}</div>
        </div>

        <div class="text-2xl font-extrabold mb-2">üèÜ ${r.full6}</div>

        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</div>
            <div class="font-bold text-green-300">${top3}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-green-300">${lower}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-pink-300">${r.bottom}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/* ============================
   Update stats: pie chart + freq2
   ============================ */
function updateStats(){
  // pie: count where first3 > last3 as top else bottom
  let topCount = 0, bottomCount = 0;
  allData.forEach(r=>{
    if(!r.full6 || r.full6.length < 6) return;
    const f = Number(r.full6.slice(0,3));
    const l = Number(r.full6.slice(3));
    if(f>l) topCount++; else bottomCount++;
  });

  const ctx = document.getElementById('pieChart')?.getContext('2d');
  if(ctx){
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels:['‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1','‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß'],
        datasets:[{ data:[topCount, bottomCount], backgroundColor:['#c084fc','#4f46e5'] }]
      },
      options:{
        plugins:{
          legend:{
            labels:{
              color:'white',
              font:{ family:'Prompt', size:13, weight:'600' }
            },
            position:'bottom'
          },
          tooltip:{
            titleColor:'white',
            bodyColor:'white',
            titleFont:{ family:'Prompt', weight:'600' },
            bodyFont:{ family:'Prompt' }
          }
        }
      }
    });
  }

  // freq 2-digit
  const freq = {};
  allData.forEach(r=>{
    if(!r.bottom) return;
    const n = pad(r.bottom,2);
    freq[n] = (freq[n]||0) + 1;
  });
  const top10 = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([n])=>n);
  const el = document.getElementById('freq2');
  if(el) el.innerHTML = top10.map(n=>`<div class="text-white badge-sm">${n}</div>`).join(' ');
}

/* ============================
   RUN AI WITH AURA (UI flow)
   - show spinner, then compute
   ============================ */
function runAIwithAura(){
  const load = document.getElementById('aiLoading');
  const result = document.getElementById('aiResult');
  if(load) load.classList.remove('hidden');
  if(result) result.classList.add('hidden');

  // give the aura animation time
  setTimeout(()=>{
    runAICalc();
    // small aura flash
    auraFlash();
  }, 900);
}

/* ============================
   Collect dataset from History table (visible entries)
   ============================ */
function getTableData(){
  const cards = Array.from(document.querySelectorAll('#historyList .result-card'));
  const clean3 = s => { const v = String(s||'').trim(); return (/^\d{3}$/.test(v) ? v : ''); };
  const clean2 = s => { const v = String(s||'').trim(); return (/^\d{2}$/.test(v) ? v : ''); };
  const clean6 = s => { const v = String(s||'').trim(); return (/^\d{6}$/.test(v) ? v : ''); };
  return cards.map(card=>({
    date: card.getAttribute('data-date')||'',
    type: card.getAttribute('data-type')||'TH',
    full6: clean6(card.getAttribute('data-full6')),
    lower3a: clean3(card.getAttribute('data-lower3a')),
    lower3b: clean3(card.getAttribute('data-lower3b')),
    bottom: clean2(card.getAttribute('data-bottom'))
  }));
}

/* ============================
   Core AI calculation (from history table)
   ============================ */
function Ai() {
  const tableData = getTableData();
  if(tableData.length === 0) {
    return { prize1: '‚Äî‚Äî', top3: ['‚Äî', '‚Äî', '‚Äî'], bottom3: ['‚Äî', '‚Äî', '‚Äî'], bottom2: ['‚Äî', '‚Äî', '‚Äî'], confidence: 0 };
  }

  // prepare arrays (most recent first from visible table)
  const arrFull = tableData.map(r=>r.full6).filter(Boolean);
  const f3Arr = arrFull.map(s=> s.slice(0,3));
  const l3Arr = arrFull.map(s=> s.slice(3));

  const is3 = s => /^\d{3}$/.test(String(s||''));
  const is2 = s => /^\d{2}$/.test(String(s||''));
  const lowerArr = [];
  tableData.forEach(r=>{
    if(is3(r.lower3a)) lowerArr.push(r.lower3a);
    if(is3(r.lower3b)) lowerArr.push(r.lower3b);
  });
  const bottomArr = tableData.map(r=>r.bottom).filter(v=>is2(v));

  // weighted frequency function (decay by index)
  const weightedFreq = (arr, decay=0.045) => {
    const m = {};
    arr.forEach((v,i)=>{
      m[v] = (m[v]||0) + Math.exp(-decay * i);
    });
    return m;
  };

  const topN = (m, n=3) => Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
  const weightedPick = (m, k=5) => {
    const entries = Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,k);
    const total = entries.reduce((s, [,w])=> s + w, 0);
    if(entries.length === 0) return '';
    if(total <= 0) return entries[0][0];
    let r = Math.random() * total;
    for(const [key, w] of entries){ r -= w; if(r <= 0) return key; }
    return entries[0][0];
  };
  const sampleUnique = (m, count=3, k=5) => {
    const res = [];
    const tmp = {...m};
    for(let i=0; i<count; i++){
      const p = weightedPick(tmp, k);
      if(!p) break;
      res.push(p);
      delete tmp[p];
    }
    return res;
  };

  const mapF = weightedFreq(f3Arr, 0.045);
  const mapL = weightedFreq(l3Arr, 0.045);

  // small delta-ish scoring: prefer repeated runs
  const deltaScore = (arr) => {
    const s = {};
    arr.forEach((v,i)=>{
      const next = arr[i+1];
      if(next && v===next) s[v]=(s[v]||0)+0.25;
      else s[v]=(s[v]||0)+0.05;
    });
    return s;
  };

  const deltaF = deltaScore(f3Arr);
  const deltaL = deltaScore(l3Arr);

  // combine maps: weight freq + delta
  const combine = (freqMap, deltaMap) => {
    const merged = {};
    Object.keys(freqMap).forEach(k => merged[k] = (merged[k]||0) + freqMap[k]*0.7 + (deltaMap[k]||0)*0.4);
    Object.keys(deltaMap).forEach(k => { if(!merged[k]) merged[k] = (deltaMap[k]||0)*0.4; });
    return merged;
  };

  const combF = combine(mapF, deltaF);
  const combL = combine(mapL, deltaL);

  let bestF = weightedPick(combF, 8) || '000';
  let bestL = weightedPick(combL, 8) || '000';

  // assemble 6-digit
  let prize1 = (bestF + bestL);

  if(Math.random() < 0.35){
    const d = prize1.split('');
    const pos = Math.floor(Math.random()*6);
    d[pos] = String(Math.floor(Math.random()*10));
    prize1 = d.join('');
  }
  if(Math.random() < 0.15){
    const n = parseInt(prize1,10) || 0;
    prize1 = String((n + 1 + Math.floor(Math.random()*97)) % 1000000).padStart(6,'0');
  }
  if(Math.random() < 0.02){
    const n = parseInt(prize1,10) || 0;
    prize1 = String((n + Math.floor(Math.random()*37)) % 1000000).padStart(6,'0');
  }

  // lower3 & bottom2 predictions
  const lowerMap = weightedFreq(lowerArr, 0.05);
  const bottomMap = weightedFreq(bottomArr, 0.06);
  const bottom3 = sampleUnique(lowerMap, 3, 8);
  if(bottom3.length < 3){
    const fb = Object.entries(lowerMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k);
    for(const x of fb){ if(bottom3.length>=3) break; if(!bottom3.includes(x)) bottom3.push(x); }
  }
  while(bottom3.length < 3) bottom3.push('‚Äî');

  const bottom2 = sampleUnique(bottomMap, 3, 8);
  if(bottom2.length < 3){
    const fb2 = Object.entries(bottomMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k);
    for(const x of fb2){ if(bottom2.length>=3) break; if(!bottom2.includes(x)) bottom2.push(x); }
  }
  while(bottom2.length < 3) bottom2.push('‚Äî');

  // top3: 3 sets from combL
  const top3 = sampleUnique(combL, 3, 5);

  // confidence: based on gap between top and second for f3 and l3
  const calcConf = (map) => {
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    if(entries.length < 2) return 60;
    const diff = entries[0][1] - entries[1][1];
    const s = Math.min(96, Math.max(35, Math.round(50 + diff * 30)));
    return s;
  };
  let confidence = Math.round((calcConf(mapF) + calcConf(mapL)) / 2);
  const jitter = Math.round((Math.random() - 0.5) * 12);
  confidence = Math.min(96, Math.max(35, confidence + jitter));

  return { prize1, top3, bottom3, bottom2, confidence };
}

function runAICalc(){
  const results = Ai();

  // update DOM (main cards)
  document.getElementById('aiSix') && (document.getElementById('aiSix').innerText = results.prize1 || '‚Äî');
  document.getElementById('aiTop3') && (document.getElementById('aiTop3').innerText = results.top3.join(', ') || '‚Äî');
  document.getElementById('aiBottom3') && (document.getElementById('aiBottom3').innerText = results.bottom3.join(', ') || '‚Äî');
  document.getElementById('aiTwo') && (document.getElementById('aiTwo').innerText = results.bottom2.join(', ') || '‚Äî');
  document.getElementById('aiScore') && (document.getElementById('aiScore').innerText = results.confidence + '%' || '‚Äî%');

  // update small summary
  if(document.getElementById('aiSix_small')) document.getElementById('aiSix_small').innerText = results.prize1 || '‚Äî';
  if(document.getElementById('aiTop3_small')) document.getElementById('aiTop3_small').innerText = results.top3.join(', ') || '‚Äî';
  if(document.getElementById('aiBottom3_small')) document.getElementById('aiBottom3_small').innerText = results.bottom3.join(', ') || '‚Äî';
  if(document.getElementById('aiTwo_small')) document.getElementById('aiTwo_small').innerText = results.bottom2.join(', ') || '‚Äî';
  if(document.getElementById('aiScore_small')) document.getElementById('aiScore_small').innerText = results.confidence + '%' || '‚Äî%';

  // finish UI
  const load = document.getElementById('aiLoading'); if(load) load.classList.add('hidden');
  const res = document.getElementById('aiResult'); if(res) res.classList.remove('hidden');
}

/* ============================
   Aura flash (temporary highlight)
   ============================ */
function auraFlash(){
  const el = document.querySelector('.aura-card');
  if(!el) return;
  const prev = el.style.boxShadow;
  el.style.boxShadow = '0 0 70px rgba(250,200,100,0.85)';
  setTimeout(()=>{ el.style.boxShadow = prev; }, 900);
}

/* ============================
   Small helper: run on load to compute initial AI
   ============================ */
function tryInitialAI(){
  // manual-only: do not auto-run AI after data load
}
// no auto-trigger; user clicks the button to run AI

/* ============================
   Utility: manual trigger for testing
   ============================ */
window.runAIwithAura = runAIwithAura;
window.runAICalc = runAICalc;

/* ============================
   Small UX: close dropdowns when clicking outside
   ============================ */
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.dd-btn') && !e.target.closest('.dd-menu')) {
    const m = document.getElementById('ddMenu'); if(m) m.classList.add('hidden');
  }
  if(!e.target.closest('#ddBtnHistory') && !e.target.closest('#ddHistoryMenu')) {
    const mh = document.getElementById('ddHistoryMenu'); if(mh) mh.classList.add('hidden');
  }
});

/* ============================
   End of script
   ============================ */
</script>


