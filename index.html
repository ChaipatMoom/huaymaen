<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LottoGenius AI ‚Äî Lucky Aura Edition</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ============================
        CSS ‚Äî TONAL MOO + AURA
       ============================ -->
  <style>

:root {
  --bg: #0f0e17;
  --card: rgba(255,255,255,0.08);
  --accent1: #a855f7;
  --accent2: #7c3aed;
  --accent3: #9f67ff;
  --gold: #facc15;
  --text: #f1f1f1;
  --muted: #b5b5b5;
  --glow: rgba(168,85,247,0.55);
}

/* Background */
body.bg-moon {
  background: radial-gradient(circle at top, #1d1633 0%, #0d0b15 70%);
  font-family:'Prompt',sans-serif;
  color: var(--text);
  -webkit-font-smoothing:antialiased;
}

/* ============================
      CARD
   ============================ */
.card {
  background: var(--card);
  border-radius: 14px;
  backdrop-filter: blur(10px);
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 0 30px rgba(0,0,0,0.45);
  transition: 0.25s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 32px rgba(168,85,247,0.22);
}

/* ============================
      AURA CARD (AI ZONE)
   ============================ */
.aura-card {
  background: linear-gradient(135deg,#4c1d95,#7c3aed);
  box-shadow: 0 0 28px rgba(124,58,237,0.8);
  position: relative;
  overflow:hidden;
  border-radius:12px;
}

.aura-card::after {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.05)
  );
  animation: auraRotate 6s linear infinite;
  opacity:0.22;
  pointer-events:none;
}

@keyframes auraRotate {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

/* ============================
      AURA BOUNCE MODAL
   ============================ */
.modal-aura {
  animation: auraPop 0.55s cubic-bezier(.25,1.8,.5,1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(168,85,247,0.55);
  border-radius: 18px;
}

@keyframes auraPop {
  0% {
    transform: scale(0.55) rotate(-4deg);
    opacity: 0;
    filter: blur(20px);
  }
  60% {
    transform: scale(1.08) rotate(2deg);
    opacity: 1;
    filter: blur(0);
  }
  100% {
    transform: scale(1);
    rotate: 0deg;
  }
}

/* swirling aura */
.modal-aura::before {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    transparent 0%,
    rgba(168,85,247,0.25) 10%,
    transparent 35%,
    rgba(255,255,255,0.1) 50%,
    rgba(168,85,247,0.22) 70%,
    transparent 100%
  );
  animation: swirlAura 8s linear infinite;
  opacity:0.45;
  pointer-events:none;
}
@keyframes swirlAura {
  to { transform: rotate(360deg); }
}

/* ============================
      BUTTON PRIMARY
   ============================ */
.btn-primary {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: white;
  padding: 11px 18px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 0 14px var(--glow);
  transition: 0.15s;
}
.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 22px var(--glow);
}

/* ============================
      INPUT / SELECT
   ============================ */
.input-dd {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text);
  border-radius:10px;
  padding: 8px 10px;
}
.input-dd:focus {
  outline:none;
  border-color: var(--accent2);
  box-shadow:0 0 10px var(--glow);
}

/* ============================
      CUSTOM DROPDOWN
   ============================ */
.dd-btn {
  background: rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.18);
  padding:8px 14px;
  color:white;
  border-radius: 10px;
  font-weight: 600;
  min-width:130px;
  transition:0.2s;
}
.dd-btn:hover {
  box-shadow:0 0 15px var(--glow);
}

.dd-menu {
  position:absolute;
  right:0;
  margin-top:8px;
  background: rgba(22,17,38,0.95);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 25px rgba(0,0,0,0.4);
  z-index:50;
  width:180px;
  padding:6px 0;
  animation:fadeSlide 0.25s ease;
}
.dd-item {
  padding:10px 14px;
  color:white;
  cursor:pointer;
  font-weight:500;
  transition:0.18s;
  display:flex;
  gap:6px;
  align-items:center;
}
.dd-item:hover {
  background: rgba(255,255,255,0.12);
  padding-left:20px;
}

/* ============================
      RESULT CARD
   ============================ */
.result-card {
  border-radius:14px;
  padding:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(8px);
  transition:0.2s;
}
.result-card:hover {
  transform:translateY(-4px);
  box-shadow:0 0 26px rgba(124,58,237,0.4);
}

/* ============================
      MODAL BACKDROP
   ============================ */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:100;
}

/* ============================
      SIMPLE SPINNER
   ============================ */
.ai-spinner {
  width:30px;
  height:30px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,0.25);
  border-top-color: var(--gold);
  animation: spin 1s linear infinite;
  margin:auto;
}
@keyframes spin {
  to { transform:rotate(360deg); }
}

/* small util classes used later */
.text-gold { color: var(--gold); }
.muted { color: rgba(255,255,255,0.6); font-size:13px; }

  </style>
</head>

<body class="bg-moon">

  <!-- ONBOARDING MODAL (PART 1 includes markup) -->
  <div id="onboard" class="modal hidden">
    <div class="modal-aura p-8 max-w-md w-full text-center text-white">
      <h1 class="text-3xl font-bold mb-2">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‚ú®</h1>
      <p class="text-white/70 mb-6">
        ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏ß‡∏¢ AI <br>
        ‡∏£‡∏∏‡πà‡∏ô Lucky Aura ‚Äî ‡πÇ‡∏î‡∏¢ LottoGenius
      </p>

      <div class="text-left mb-6 space-y-2 text-white/80">
        <div>üîÆ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏ö‡∏ö Ensemble Boost</div>
        <div>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏•‡∏±‡∏ö</div>
        <div>üé≤ Lucky 2 ‡∏ï‡∏±‡∏ß / 3 ‡∏ï‡∏±‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏° % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</div>
        <div>üèÜ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      </div>

      <button onclick="closeOnboard()" class="btn-primary w-full py-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <!-- ADD RESULT MODAL -->
  <div id="addModal" class="modal hidden">
    <div class="modal-aura max-w-md w-full p-6 text-white">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</h2>
        <button onclick="closeAddModal()" class="text-red-300 text-lg">‚úï</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
          <input id="dateInput" type="date" class="input-dd w-full" />
        </div>

        <div>
          <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</label>
          <input id="firstPrizeInput" type="text" maxlength="6" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 461252" />
        </div>

        <div>
          <label class="text-sm">3 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
          <input id="threeBottomInput" type="text" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 137, 995" />
        </div>

        <div>
          <label class="text-sm">2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label>
          <input id="twoBottomInput" type="text" maxlength="2" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 22" />
        </div>
      </div>

      <div class="mt-6">
        <button onclick="saveResult()" class="btn-primary w-full py-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- HEADER / TOP -->
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 0 18px var(--glow);">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2l2.6 5.8L21 9l-4.5 3.3L17.2 20 12 16.9 6.8 20l.7-7.7L3 9l6.4-1.2L12 2z"/></svg>
      </div>
      <div>
        <div class="text-xl font-bold text-gold">LottoGenius AI</div>
        <div class="muted text-xs">Lucky Aura ¬∑ Ensemble</div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="openAddModal()" class="btn-primary flex items-center gap-2">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 5v14m7-7H5" stroke="white" stroke-width="2"/></svg>
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
      </button>

      <!-- dropdown trigger -->
      <div class="relative">
        <button onclick="toggleDD()" class="dd-btn flex items-center gap-2">
          <span id="ddFlag">üáπüá≠</span>
          <span id="ddLabel">‡πÑ‡∏ó‡∏¢</span>
        </button>

        <div id="ddMenu" class="dd-menu hidden">
          <div class="dd-item" onclick="setDD('‡πÑ‡∏ó‡∏¢','üáπüá≠')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</div>
          <div class="dd-item" onclick="setDD('‡∏•‡∏≤‡∏ß','üá±üá¶')">üá±üá¶ ‡∏•‡∏≤‡∏ß</div>
          <div class="dd-item" onclick="setDD('‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢','üáªüá≥')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI AURA CARD -->
  <div class="max-w-6xl mx-auto px-4">
    <div class="aura-card p-6 mt-4">
      <h2 class="text-lg font-bold text-white mb-3">üåü ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á AI (Lucky Aura)</h2>

      <div id="aiLoading" class="hidden text-center my-6">
        <div class="ai-spinner"></div>
        <p class="text-white/60 mt-2 text-sm">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...</p>
      </div>

      <div id="aiResult" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-white">
        <div class="card">
          <div class="text-sm muted">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (6 ‡∏´‡∏•‡∏±‡∏Å)</div>
          <div id="aiSix" class="text-2xl font-bold">‚Äî</div>
        </div>

        <div class="card">
          <div class="text-sm muted">üéØ 3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</div>
          <div id="aiTop3" class="text-xl font-semibold">‚Äî</div>
        </div>

        <div class="card">
          <div class="text-sm muted">üé≤ 3 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</div>
          <div id="aiBottom3" class="text-xl font-semibold">‚Äî</div>
        </div>

        <div class="card">
          <div class="text-sm muted">‚ú® 2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</div>
          <div id="aiTwo" class="text-xl font-semibold">‚Äî</div>
          <div class="text-xs muted mt-2">Confidence: <span id="aiScore">‚Äî%</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PART 2 and PART 3 will continue after this block -->
  <!-- ===============================
       MAIN CONTENT
       =============================== -->
  <main class="max-w-6xl mx-auto px-4 mt-8">

    <!-- STAT CARDS -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

      <!-- Frequent 2 Digits -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üî• ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
        <div id="freq2" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <!-- Pie Chart -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">‚öñÔ∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô vs ‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏á</h3>
        <canvas id="pieChart" height="160"></canvas>
      </div>

      <!-- AI Aura Summary -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üîÆ ‡∏™‡∏£‡∏∏‡∏õ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô AI</h3>

        <div class="text-sm text-white/70 space-y-1">
          <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1:  
            <span id="aiSix_small" class="text-gold font-bold"></span>
          </div>
          <div>3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô: <span id="aiTop3_small" class="text-gold"></span></div>
          <div>3 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á: <span id="aiBottom3_small" class="text-gold"></span></div>
          <div>2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á: <span id="aiTwo_small" class="text-gold"></span></div>
          <div>Confidence: <span id="aiScore_small" class="text-gold font-bold"></span></div>
        </div>
      </div>

    </section>


    <!-- ===============================
         RESULT HISTORY
         =============================== -->
    <section class="card mb-10">
      <div class="flex justify-between items-center mb-4">

        <div>
          <h2 class="text-xl font-bold text-white">‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
          <div class="text-xs text-white/60">‡πÅ‡∏™‡∏î‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 12 ‡∏á‡∏ß‡∏î</div>
        </div>

        <!-- Dropdown Filter -->
        <div class="relative">
          <button id="ddBtnHistory" onclick="toggleDDHistory()" class="dd-btn flex items-center gap-2">
            <span id="ddHistoryFlag">üåê</span>
            <span id="ddHistoryLabel">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
          </button>

          <div id="ddHistoryMenu" class="dd-menu hidden">
            <div class="dd-item" onclick="setHistoryFilter('all','üåê','‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">üåê ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="dd-item" onclick="setHistoryFilter('TH','üáπüá≠','‡πÑ‡∏ó‡∏¢')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</div>
            <div class="dd-item" onclick="setHistoryFilter('LAO','üá±üá¶','‡∏•‡∏≤‡∏ß')">üá±üá¶ ‡∏•‡∏≤‡∏ß</div>
            <div class="dd-item" onclick="setHistoryFilter('HANOI','üáªüá≥','‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</div>
          </div>
        </div>

      </div>

      <!-- History List -->
      <div id="historyList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </section>



    <!-- ===============================
         SIMULATOR (ADD RESULT QUICK)
         =============================== -->
    <section class="card p-5 mb-10">
      <h3 class="font-semibold text-white mb-4">üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà (Simulator)</h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-3">
        
        <select id="simType" class="input-dd">
          <option value="TH">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
          <option value="LAO">üá±üá¶ ‡∏•‡∏≤‡∏ß</option>
          <option value="HANOI">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</option>
        </select>

        <input id="simDate" type="date" class="input-dd"/>

        <input id="simFull6" maxlength="6" placeholder="‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1" class="input-dd text-center"/>

        <input id="simLowerA" maxlength="3" placeholder="3 ‡∏•‡πà‡∏≤‡∏á 1" class="input-dd text-center"/>
        <input id="simLowerB" maxlength="3" placeholder="3 ‡∏•‡πà‡∏≤‡∏á 2" class="input-dd text-center"/>
        
        <input id="simBottom" maxlength="2" placeholder="2 ‡∏•‡πà‡∏≤‡∏á" class="input-dd text-center"/>

        <button onclick="saveSimulator()" class="btn-primary w-full">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>

    </section>

  </main>
<script>
/* ============================
   Firebase config & init
   ============================ */
const firebaseConfig = {
  apiKey:"AIzaSyCkS6eu3SuB5McIkS_7J8srMIhXQ7osc-E",
  authDomain:"huaymaen-lottoai.firebaseapp.com",
  databaseURL:"https://huaymaen-lottoai-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"huaymaen-lottoai",
  storageBucket:"huaymaen-lottoai.firebasestorage.app",
  messagingSenderId:"326340239586",
  appId:"1:326340239586:web:563d03ca906ca4ba327ebb",
  measurementId:"G-MF97ZM968E"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("lottery");

/* ============================
   Global state
   ============================ */
let allData = [];          // raw data from firebase
let historyFilter = 'all'; // 'all'|'‡πÑ‡∏ó‡∏¢'|'‡∏•‡∏≤‡∏ß'|'‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'
let pieChart = null;

/* ======= small utils ======= */
const pad = (s,n=2)=>String(s||'').padStart(n,'0');
const isDigits = s => /^\d+$/.test(String(s||''));

/* ============================
   ONBOARDING (open once)
   ============================ */
function openOnboard(){ document.getElementById('onboard').classList.remove('hidden'); }
function closeOnboard(){
  document.getElementById('onboard').classList.add('hidden');
  localStorage.setItem('lg_onboard_done','yes');
}
(function maybeOpenOnboard(){
  const done = localStorage.getItem('lg_onboard_done');
  if(!done) setTimeout(openOnboard, 700);
})();

/* ============================
   ADD RESULT MODAL controls
   ============================ */
function openAddModal(){ document.getElementById('addModal').classList.remove('hidden'); }
function closeAddModal(){
  document.getElementById('addModal').classList.add('hidden');
  // clear fields
  const ids = ['dateInput','firstPrizeInput','threeBottomInput','twoBottomInput'];
  ids.forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
}

/* ============================
   Header dropdown (flag)
   ============================ */
function toggleDD(){
  const menu = document.getElementById('ddMenu');
  if(menu) menu.classList.toggle('hidden');
}
function setDD(label, flag){
  const lbl = document.getElementById('ddLabel');
  const f = document.getElementById('ddFlag');
  if(lbl) lbl.innerText = label;
  if(f) f.innerText = flag;
  // no immediate filtering required here (this is visual header)
  // close menu
  const menu = document.getElementById('ddMenu'); if(menu) menu.classList.add('hidden');
}

/* ============================
   History dropdown filter
   ============================ */
function toggleDDHistory(){
  const m = document.getElementById('ddHistoryMenu');
  if(m) m.classList.toggle('hidden');
}
function setHistoryFilter(key, flag, label){
  historyFilter = key; // use key directly ('‡πÑ‡∏ó‡∏¢'/'‡∏•‡∏≤‡∏ß'/'‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'/'all')
  const lbl = document.getElementById('ddHistoryLabel');
  const f = document.getElementById('ddHistoryFlag');
  if(lbl) lbl.innerText = label;
  if(f) f.innerText = flag;
  const m = document.getElementById('ddHistoryMenu'); if(m) m.classList.add('hidden');
  renderHistory(); // re-render with filter
}

/* ============================
   PLAY SAVE SOUND
   ============================ */
function playSaveSound(){
  try{
    const audio = new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_7e953a57c8.mp3?filename=ui-design-confirmation-4-20687.mp3");
    audio.volume = 0.35;
    audio.play().catch(()=>{/* ignore autoplay block */});
  }catch(e){}
}

/* ============================
   Helper: check duplicate by date+type
   ============================ */
function hasDuplicate(dateStr, typeStr){
  return allData.some(r => String(r.date) === String(dateStr) && String(r.type) === String(typeStr));
}

/* ============================
   Save result from Add Modal
   - validate fields
   - prevent duplicate date+type
   - push to firebase
   - clear & close
   - trigger AI run + effects
   ============================ */
async function saveResult(){
  const dateVal = document.getElementById('dateInput').value;
  const full6 = (document.getElementById('firstPrizeInput').value||'').trim();
  const three = (document.getElementById('threeBottomInput').value||'').trim();
  const two = (document.getElementById('twoBottomInput').value||'').trim();

  if(!dateVal || !full6 || !two){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà1 6‡∏´‡∏•‡∏±‡∏Å, 2‡∏•‡πà‡∏≤‡∏á)');
    return;
  }
  if(!isDigits(full6) || full6.length !== 6){
    alert('‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }
  if(!isDigits(two) || two.length !== 2){
    alert('2 ‡∏•‡πà‡∏≤‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }

  const dnum = dateVal.replace(/-/g,'');
  // detect type: header ddLabel has '‡πÑ‡∏ó‡∏¢' etc (we'll use header flag as type)
  const hdr = (document.getElementById('ddLabel')?.innerText || '‡πÑ‡∏ó‡∏¢');
  const type = hdr; // '‡πÑ‡∏ó‡∏¢'/'‡∏•‡∏≤‡∏ß'/'‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'

  if(hasDuplicate(dnum, type)){
    // allow user to close modal and go see results -> do not block
    const ok = confirm('‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å? \n\nOK = ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å, Cancel = ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡∏¥‡∏î');
    if(ok){
      closeAddModal();
      return;
    } else {
      return;
    }
  }

  // parse three bottom (csv)
  let bottomA='---', bottomB='---';
  if(three){
    const parts = three.split(',').map(s=>s.trim()).filter(Boolean);
    bottomA = parts[0]||'---';
    bottomB = parts[1]||'---';
  }

  const payload = {
    date: dnum,
    type: type,
    full6: pad(full6,6),
    lower3a: bottomA,
    lower3b: bottomB,
    bottom: pad(two,2)
  };

  await db.push(payload);
  playSaveSound();

  // close + clear
  closeAddModal();

  // run AI & small flash
  runAIwithAura();
}

/* ============================
   Simulator quick-save (bottom form)
   same validations and behavior
   ============================ */
async function saveSimulator(){
  const sType = document.getElementById('simType').value || '‡πÑ‡∏ó‡∏¢';
  const sDate = document.getElementById('simDate').value;
  const sFull = (document.getElementById('simFull6').value||'').trim();
  const sA = (document.getElementById('simLowerA').value||'').trim();
  const sB = (document.getElementById('simLowerB').value||'').trim();
  const sTwo = (document.getElementById('simBottom').value||'').trim();

  if(!sDate || !sFull || !sTwo){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•6‡∏´‡∏•‡∏±‡∏Å, 2‡∏•‡πà‡∏≤‡∏á)');
    return;
  }
  if(!isDigits(sFull) || sFull.length !== 6){
    alert('‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }
  if(!isDigits(sTwo) || sTwo.length !== 2){
    alert('2 ‡∏•‡πà‡∏≤‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å');
    return;
  }

  const dnum = sDate.replace(/-/g,'');
  if(hasDuplicate(dnum, sType)){
    if(!confirm('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?')) return;
    // allow close: do nothing else
    return;
  }

  const payload = {
    date: dnum,
    type: sType,
    full6: pad(sFull,6),
    lower3a: sA || '---',
    lower3b: sB || '---',
    bottom: pad(sTwo,2)
  };

  await db.push(payload);
  playSaveSound();

  // clear simulator inputs
  ['simDate','simFull6','simLowerA','simLowerB','simBottom'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });

  // run AI
  runAIwithAura();
}

/* ============================
   Firebase listener -> keep allData up-to-date
   ============================ */
db.on('value', snap=>{
  allData = [];
  snap.forEach(ch=>{
    const v = ch.val();
    // ensure fields exist to avoid runtime errors
    allData.push({
      date: String(v.date||''),
      type: String(v.type||'‡πÑ‡∏ó‡∏¢'),
      full6: String(v.full6||'000000'),
      lower3a: String(v.lower3a||'---'),
      lower3b: String(v.lower3b||'---'),
      bottom: String(v.bottom||'00')
    });
  });
  // sort desc by date (string compare ok for YYYYMMDD)
  allData.sort((a,b)=> b.date.localeCompare(a.date));

  renderHistory();
  updateStats();

  // if dataset just became non-empty and onboarding not done -> don't force modal
  // AI initial run
  runAICalc();
});

/* ============================
   Render history (cards)
   - respect historyFilter
   - latest 12 entries
   ============================ */
function renderHistory(){
  const box = document.getElementById('historyList');
  if(!box) return;
  
  let arr = allData.slice();

  // DEDUPLICATE first: keep only first occurrence of each date+type
  const seen = new Set();
  arr = arr.filter(r => {
    const key = r.date + '|' + r.type;
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  // Apply type filter (only if not 'all')
  if(historyFilter && historyFilter !== 'all'){
    arr = arr.filter(r => String(r.type).trim() === String(historyFilter).trim());
  }

  arr = arr.slice(0, 12);

  if(arr.length === 0){
    box.innerHTML = `<div class="text-white/60 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    return;
  }

  box.innerHTML = arr.map(r => {
    const top3 = (r.full6 && r.full6.length === 6) ? r.full6.slice(-3) : '-';
    const lower = [r.lower3a, r.lower3b].filter(x => x && x !== '---').join(", ") || '-';
    const flag = r.type === 'TH' ? 'üáπüá≠' : r.type === 'LAO' ? 'üá±üá¶' : r.type === 'HANOI' ? 'üáªüá≥' : 'üåê';
    const typeLabel = r.type === 'TH' ? '‡πÑ‡∏ó‡∏¢' : r.type === 'LAO' ? '‡∏•‡∏≤‡∏ß' : r.type === 'HANOI' ? '‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢' : r.type;
    const dateFmt = `${r.date.slice(6,8)}/${r.date.slice(4,6)}/${r.date.slice(0,4)}`;

    return `
      <div class="result-card p-4">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm text-white/70">${flag} <span class="font-semibold ml-1">${typeLabel}</span></div>
          <div class="text-xs text-yellow-300">üìÖ ${dateFmt}</div>
        </div>

        <div class="text-2xl font-extrabold mb-2">üèÜ ${r.full6}</div>

        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="text-center">
            <div class="text-xs text-white/60">3 ‡∏ö‡∏ô</div>
            <div class="font-bold text-green-300">${top3}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">3 ‡∏•‡πà‡∏≤‡∏á</div>
            <div class="font-bold text-green-300">${lower}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">2 ‡∏•‡πà‡∏≤‡∏á</div>
            <div class="font-bold text-pink-300">${r.bottom}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/* ============================
   Update stats: pie chart + freq2
   ============================ */
function updateStats(){
  // pie: count where first3 > last3 as top else bottom
  let topCount = 0, bottomCount = 0;
  allData.forEach(r=>{
    if(!r.full6 || r.full6.length < 6) return;
    const f = Number(r.full6.slice(0,3));
    const l = Number(r.full6.slice(3));
    if(f>l) topCount++; else bottomCount++;
  });

  const ctx = document.getElementById('pieChart')?.getContext('2d');
  if(ctx){
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels:['‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô','‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏á'],
        datasets:[{ data:[topCount, bottomCount], backgroundColor:['#c084fc','#4f46e5'] }]
      },
      options:{ plugins:{ legend:{ labels:{ color:'white' }, position:'bottom' } } }
    });
  }

  // freq 2-digit
  const freq = {};
  allData.forEach(r=>{
    if(!r.bottom) return;
    const n = pad(r.bottom,2);
    freq[n] = (freq[n]||0) + 1;
  });
  const top5 = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n])=>n);
  const el = document.getElementById('freq2');
  if(el) el.innerHTML = top5.map(n=>`<div class="text-white badge-sm">${n}</div>`).join(' ');
}

/* ============================
   RUN AI WITH AURA (UI flow)
   - show spinner, then compute
   ============================ */
function runAIwithAura(){
  const load = document.getElementById('aiLoading');
  const result = document.getElementById('aiResult');
  if(load) load.classList.remove('hidden');
  if(result) result.classList.add('hidden');

  // give the aura animation time
  setTimeout(()=>{
    runAICalc();
    // small aura flash
    auraFlash();
  }, 900);
}

/* ============================
   Core AI calculation
   - weighted freq + delta-ish + ensemble-ish
   - returns and updates UI
   ============================ */
function runAICalc(){
  if(allData.length === 0){
    // clear UI
    ['aiSix','aiTop3','aiBottom3','aiTwo','aiScore','aiSix_small','aiTop3_small','aiBottom3_small','aiTwo_small','aiScore_small']
      .forEach(id=>{ if(document.getElementById(id)) document.getElementById(id).innerText = '‚Äî'; });
    document.getElementById('aiLoading') && document.getElementById('aiLoading').classList.add('hidden');
    return;
  }

  // prepare arrays (most recent first)
  const arrFull = allData.map(r=>r.full6).filter(Boolean);
  const f3Arr = arrFull.map(s=> s.slice(0,3));
  const l3Arr = arrFull.map(s=> s.slice(3));

  const lowerArr = [];
  allData.forEach(r=>{
    if(r.lower3a && r.lower3a!=='---') lowerArr.push(r.lower3a);
    if(r.lower3b && r.lower3b!=='---') lowerArr.push(r.lower3b);
  });
  const bottomArr = allData.map(r=>r.bottom).filter(Boolean);

  // weighted frequency function (decay by index)
  const weightedFreq = (arr, decay=0.045) => {
    const m = {};
    arr.forEach((v,i)=>{
      m[v] = (m[v]||0) + Math.exp(-decay * i);
    });
    return m;
  };

  const topN = (m, n=5) => Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);

  const mapF = weightedFreq(f3Arr, 0.045);
  const mapL = weightedFreq(l3Arr, 0.045);

  // small delta-ish scoring: prefer repeated runs
  const deltaScore = (arr) => {
    const s = {};
    arr.forEach((v,i)=>{
      const next = arr[i+1];
      if(next && v===next) s[v]=(s[v]||0)+0.25;
      else s[v]=(s[v]||0)+0.05;
    });
    return s;
  };

  const deltaF = deltaScore(f3Arr);
  const deltaL = deltaScore(l3Arr);

  // combine maps: weight freq + delta
  const combine = (freqMap, deltaMap) => {
    const merged = {};
    Object.keys(freqMap).forEach(k => merged[k] = (merged[k]||0) + freqMap[k]*0.7 + (deltaMap[k]||0)*0.4);
    Object.keys(deltaMap).forEach(k => { if(!merged[k]) merged[k] = (deltaMap[k]||0)*0.4; });
    return merged;
  };

  const combF = combine(mapF, deltaF);
  const combL = combine(mapL, deltaL);

  const candF = topN(combF, 5);
  const candL = topN(combL, 5);

  const pick = arr => arr && arr.length ? arr[0] : '000';

  let bestF = pick(candF);
  let bestL = pick(candL);

  // assemble 6-digit
  let fullPredict = (bestF + bestL);

  // slight lucky jitter (very small chance)
  if(Math.random() < 0.02){
    const n = parseInt(fullPredict,10) || 0;
    fullPredict = String((n + Math.floor(Math.random()*37)) % 1000000).padStart(6,'0');
  }

  // lower3 & bottom2 predictions
  const lowerMap = weightedFreq(lowerArr, 0.05);
  const bottomMap = weightedFreq(bottomArr, 0.06);
  const lowerPred = topN(lowerMap, 3);
  const bottomPred = topN(bottomMap, 5);

  // confidence: based on gap between top and second for f3 and l3
  const calcConf = (map) => {
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    if(entries.length < 2) return 60;
    const diff = entries[0][1] - entries[1][1];
    const s = Math.min(96, Math.max(35, Math.round(50 + diff * 30)));
    return s;
  };
  const conf = Math.round((calcConf(mapF) + calcConf(mapL)) / 2);

  // update DOM (main cards)
  document.getElementById('aiSix') && (document.getElementById('aiSix').innerText = fullPredict);
  document.getElementById('aiTop3') && (document.getElementById('aiTop3').innerText = fullPredict.slice(-3));
  document.getElementById('aiBottom3') && (document.getElementById('aiBottom3').innerText = lowerPred[0]||'‚Äî');
  document.getElementById('aiTwo') && (document.getElementById('aiTwo').innerText = (bottomPred[0]||'‚Äî'));
  document.getElementById('aiScore') && (document.getElementById('aiScore').innerText = conf + '%');

  // update small summary
  if(document.getElementById('aiSix_small')) document.getElementById('aiSix_small').innerText = fullPredict;
  if(document.getElementById('aiTop3_small')) document.getElementById('aiTop3_small').innerText = fullPredict.slice(-3);
  if(document.getElementById('aiBottom3_small')) document.getElementById('aiBottom3_small').innerText = lowerPred[0]||'‚Äî';
  if(document.getElementById('aiTwo_small')) document.getElementById('aiTwo_small').innerText = bottomPred[0]||'‚Äî';
  if(document.getElementById('aiScore_small')) document.getElementById('aiScore_small').innerText = conf + '%';

  // finish UI
  const load = document.getElementById('aiLoading'); if(load) load.classList.add('hidden');
  const res = document.getElementById('aiResult'); if(res) res.classList.remove('hidden');
}

/* ============================
   Aura flash (temporary highlight)
   ============================ */
function auraFlash(){
  const el = document.querySelector('.aura-card');
  if(!el) return;
  const prev = el.style.boxShadow;
  el.style.boxShadow = '0 0 70px rgba(250,200,100,0.85)';
  setTimeout(()=>{ el.style.boxShadow = prev; }, 900);
}

/* ============================
   Small helper: run on load to compute initial AI
   ============================ */
function tryInitialAI(){
  if(allData.length > 0) runAICalc();
}
setTimeout(tryInitialAI, 600);

/* ============================
   Utility: manual trigger for testing
   ============================ */
window.runAIwithAura = runAIwithAura;
window.runAICalc = runAICalc;

/* ============================
   Small UX: close dropdowns when clicking outside
   ============================ */
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.dd-btn') && !e.target.closest('.dd-menu')) {
    const m = document.getElementById('ddMenu'); if(m) m.classList.add('hidden');
  }
  if(!e.target.closest('#ddBtnHistory') && !e.target.closest('#ddHistoryMenu')) {
    const mh = document.getElementById('ddHistoryMenu'); if(mh) mh.classList.add('hidden');
  }
});

/* ============================
   End of script
   ============================ */
</script>
