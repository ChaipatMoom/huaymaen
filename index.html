<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢ ‚Äî Lucky Aura Edition</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ============================
        CSS ‚Äî TONAL MOO + AURA
       ============================ -->
  <style>

:root {
  --bg: #0f0e17;
  --card: rgba(255,255,255,0.08);
  --accent1: #a855f7;
  --accent2: #7c3aed;
  --accent3: #9f67ff;
  --gold: #facc15;
  --text: #f1f1f1;
  --muted: #b5b5b5;
  --glow: rgba(168,85,247,0.55);
}

/* Background */
body.bg-moon {
  background: radial-gradient(circle at top, #1d1633 0%, #0d0b15 70%);
  font-family:'Prompt',sans-serif;
  color: var(--text);
  -webkit-font-smoothing:antialiased;
}

/* ============================
      CARD
   ============================ */
.card {
  background: var(--card);
  border-radius: 14px;
  backdrop-filter: blur(10px);
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 0 30px rgba(0,0,0,0.45);
  transition: 0.25s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 32px rgba(168,85,247,0.22);
}

/* ============================
      AURA CARD (AI ZONE)
   ============================ */
.aura-card {
  background: linear-gradient(135deg,#4c1d95,#7c3aed);
  box-shadow: 0 0 28px rgba(124,58,237,0.8);
  position: relative;
  overflow:hidden;
  border-radius:12px;
}

.aura-card::after {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    rgba(255,255,255,0.05),
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.05)
  );
  animation: auraRotate 6s linear infinite;
  opacity:0.22;
  pointer-events:none;
}

@keyframes auraRotate {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

/* ============================
      AURA BOUNCE MODAL
   ============================ */
.modal-aura {
  animation: auraPop 0.55s cubic-bezier(.25,1.8,.5,1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(168,85,247,0.55);
  border-radius: 18px;
}

@keyframes auraPop {
  0% {
    transform: scale(0.55) rotate(-4deg);
    opacity: 0;
    filter: blur(20px);
  }
  60% {
    transform: scale(1.08) rotate(2deg);
    opacity: 1;
    filter: blur(0);
  }
  100% {
    transform: scale(1);
    rotate: 0deg;
  }
}

/* swirling aura */
.modal-aura::before {
  content:"";
  position:absolute;
  inset:0;
  background: conic-gradient(
    from 0deg,
    transparent 0%,
    rgba(168,85,247,0.25) 10%,
    transparent 35%,
    rgba(255,255,255,0.1) 50%,
    rgba(168,85,247,0.22) 70%,
    transparent 100%
  );
  animation: swirlAura 8s linear infinite;
  opacity:0.45;
  pointer-events:none;
}
@keyframes swirlAura {
  to { transform: rotate(360deg); }
}

/* ============================
      BUTTON PRIMARY
   ============================ */
.btn-primary {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: white;
  padding: 11px 18px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 0 14px var(--glow);
  transition: 0.15s;
}
.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 22px var(--glow);
}

/* ============================
      INPUT / SELECT
   ============================ */
.input-dd {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text);
  border-radius:10px;
  padding: 8px 10px;
}
.input-dd:focus {
  outline:none;
  border-color: var(--accent2);
  box-shadow:0 0 10px var(--glow);
}

/* ============================
      CUSTOM DROPDOWN
   ============================ */
.dd-btn {
  background: rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.18);
  padding:8px 14px;
  color:white;
  border-radius: 10px;
  font-weight: 600;
  min-width:130px;
  transition:0.2s;
}
.dd-btn:hover {
  box-shadow:0 0 15px var(--glow);
}

.dd-menu {
  position:absolute;
  right:0;
  margin-top:8px;
  background: rgba(22,17,38,0.95);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 25px rgba(0,0,0,0.4);
  z-index:50;
  width:180px;
  padding:6px 0;
  animation:fadeSlide 0.25s ease;
}
.dd-item {
  padding:10px 14px;
  color:white;
  cursor:pointer;
  font-weight:500;
  transition:0.18s;
  display:flex;
  gap:6px;
  align-items:center;
}
.dd-item:hover {
  background: rgba(255,255,255,0.12);
  padding-left:20px;
}

/* ============================
      RESULT CARD
   ============================ */
.result-card {
  border-radius:14px;
  padding:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(8px);
  transition:0.2s;
}
.result-card:hover {
  transform:translateY(-4px);
  box-shadow:0 0 26px rgba(124,58,237,0.4);
}

/* ============================
      MODAL BACKDROP
   ============================ */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:100;
}

/* ============================
      SIMPLE SPINNER
   ============================ */
.ai-spinner {
  width:30px;
  height:30px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,0.25);
  border-top-color: var(--gold);
  animation: spin 1s linear infinite;
  margin:auto;
}
@keyframes spin {
  to { transform:rotate(360deg); }
}

/* small util classes used later */
.text-gold { color: var(--gold); }
.muted { color: rgba(255,255,255,0.6); font-size:13px; }

/* ============================
      RESPONSIVE IMPROVEMENTS
   ============================ */

/* Mobile-first base adjustments */
body.bg-moon {
  min-height: 100vh;
  padding-bottom: 20px;
}

/* Mobile: Reduce padding and font sizes */
@media (max-width: 640px) {
  .btn-primary {
    padding: 10px 14px;
    font-size: 13px;
  }
  
  .card {
    padding: 12px;
    border-radius: 10px;
  }
  
  .aura-card {
    padding: 16px 12px !important;
  }
  
  .dd-btn {
    min-width: 100px;
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .input-dd {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 10px 8px;
  }
  
  h1 { font-size: 24px !important; }
  h2 { font-size: 18px !important; }
  h3 { font-size: 16px !important; }
}

/* Tablet: Moderate adjustments */
@media (min-width: 641px) and (max-width: 1024px) {
  .btn-primary { padding: 10px 16px; font-size: 14px; }
  .card { padding: 14px; }
  .input-dd { font-size: 14px; }
}

/* Desktop: Full optimizations */
@media (min-width: 1025px) {
  .btn-primary { padding: 11px 18px; font-size: 14px; }
  .card { padding: 16px; }
  .aura-card { padding: 24px !important; }
  .dd-btn { min-width: 140px; }
}

/* Header responsiveness */
@media (max-width: 768px) {
  .header-container { flex-wrap: wrap; gap: 12px; }
  .header-left { width: 100%; margin-bottom: 8px; }
  .header-right { width: 100%; justify-content: flex-start; }
}

/* Stat Grid */
@media (max-width: 640px) { .stat-grid { grid-template-columns: 1fr; } }
@media (min-width: 641px) and (max-width: 1024px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1025px) { .stat-grid { grid-template-columns: repeat(3, 1fr); } }

/* Result Grid */
@media (max-width: 640px) { .result-grid { grid-template-columns: 1fr; } }
@media (min-width: 641px) and (max-width: 1024px) { .result-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1025px) { .result-grid { grid-template-columns: repeat(3, 1fr); } }

/* AI Result grid */
@media (max-width: 640px) {
  .ai-result-grid { grid-template-columns: 1fr; gap: 12px; }
  .ai-result-grid .card > div:first-child { font-size: 11px; }
}
@media (min-width: 641px) and (max-width: 1024px) {
  .ai-result-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (min-width: 1025px) {
  .ai-result-grid { grid-template-columns: repeat(4, 1fr); }
}

/* Modal responsiveness */
@media (max-width: 640px) {
  .modal { padding: 16px; }
  .modal-aura { max-width: 90vw; max-height: 90vh; overflow-y: auto; }
}

/* Simulator grid removed */

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .btn-primary, .dd-btn, .dd-item {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }
  .input-dd { min-height: 44px; font-size: 16px; }
  .card:hover { transform: none; }
  .result-card:hover { transform: none; }
}

  </style>
</head>

<body class="bg-moon">

  <!-- ONBOARDING MODAL (PART 1 includes markup) -->
  <div id="onboard" class="modal hidden">
    <div class="modal-aura p-8 max-w-md w-full text-center text-white">
      <h1 class="text-3xl font-bold mb-2">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‚ú®</h1>
      <p class="text-white/70 mb-6">
        ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏ß‡∏¢ AI <br>
        ‡∏£‡∏∏‡πà‡∏ô Lucky Aura ‚Äî hybrid-calculate algorithm by Chaipat
      </p>

      <div class="text-left mb-6 space-y-2 text-white/80">
        <div>üîÆ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏ö‡∏ö hybrid-calculate Boost</div>
        <div>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏•‡∏±‡∏ö‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î</div>
        <div>üé≤ Lucky 2 ‡∏ï‡∏±‡∏ß / 3 ‡∏ï‡∏±‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏° % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</div>
        <div>üèÜ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      </div>

      <button onclick="closeOnboard()" class="btn-primary w-full py-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <!-- ADD RESULT MODAL -->
  <div id="addModal" class="modal hidden">
    <div class="modal-aura max-w-md w-full p-6 text-white">
      <div class="flex justify-between items-center mb-4">
        <h2 id="addModalTitle" class="text-xl font-bold">üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</h2>
        <button onclick="closeAddModal()" class="text-red-300 text-lg">‚úï</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
          <input id="dateInput" type="date" class="input-dd w-full" />
        </div>

        <div>
          <label class="text-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <div class="grid grid-cols-3 gap-2">
            <button id="typeTHBtn" class="dd-btn w-full" onclick="setAddType('TH')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
            <button id="typeLAOBtn" class="dd-btn w-full" onclick="setAddType('LAO')">üá±üá¶ ‡∏•‡∏≤‡∏ß</button>
            <button id="typeHANOIBtn" class="dd-btn w-full" onclick="setAddType('HANOI')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</button>
          </div>
        </div>

        <div id="addSectionTH">
          <div>
            <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</label>
            <input id="firstPrizeInput" type="text" maxlength="6" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 461252" />
          </div>

          <div>
            <label class="text-sm">3 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label>
            <div class="grid grid-cols-2 gap-2">
              <input id="threeBottomAInput" type="text" maxlength="3" class="input-dd w-full text-center" placeholder="‡πÄ‡∏ä‡πà‡∏ô 137" />
              <input id="threeBottomBInput" type="text" maxlength="3" class="input-dd w-full text-center" placeholder="‡πÄ‡∏ä‡πà‡∏ô 995" />
            </div>
          </div>

          <div>
            <label class="text-sm">2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label>
            <input id="twoBottomInput" type="text" maxlength="2" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 22" />
          </div>
        </div>

        <div id="addSectionLAO" class="hidden">
          <div>
            <label class="text-sm">‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß</label>
            <input id="laoSixInput" type="text" maxlength="6" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 559145" />
          </div>
          <div>
            <label class="text-sm">‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß</label>
            <input id="laoLast4Input" type="text" maxlength="4" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1234" />
          </div>
          <div>
            <label class="text-sm">‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</label>
            <input id="laoLast3Input" type="text" maxlength="3" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 234" />
          </div>
          <div>
            <label class="text-sm">‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5)</label>
            <input id="laoLast2MultiInput" type="text" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12,34,56,78,90" />
          </div>
        </div>

        <div id="addSectionHANOI" class="hidden">
          <div>
            <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (5 ‡∏´‡∏•‡∏±‡∏Å)</label>
            <input id="hnFirst5Input" type="text" maxlength="5" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" />
          </div>
          <div>
            <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3)</label>
            <input id="hnPrize6Input" type="text" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123,456,789" />
          </div>
          <div>
            <label class="text-sm">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4)</label>
            <input id="hnPrize7Input" type="text" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12,34,56,78" />
          </div>
          <div>
            <label class="text-sm">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</label>
            <input id="hnTwoBottomInput" type="text" maxlength="2" class="input-dd w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 22" />
          </div>
        </div>
      </div>

      <div class="mt-6">
        <button onclick="saveResult()" class="btn-primary w-full py-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- HEADER / TOP -->
  <div class="max-w-6xl mx-auto px-4 py-3 sm:py-4 header-container flex items-center justify-between">
    <div class="header-left flex items-center gap-2 sm:gap-3">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 0 18px var(--glow);">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2l2.6 5.8L21 9l-4.5 3.3L17.2 20 12 16.9 6.8 20l.7-7.7L3 9l6.4-1.2L12 2z"/></svg>
      </div>
      <div>
        <div class="text-lg sm:text-xl font-bold text-gold">AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡πÜ</div>
        <div class="muted text-xs">Ai ¬∑ hybrid-calculate algorithm by Chaipat</div>
      </div>
    </div>

    <div class="header-right flex items-center gap-2 sm:gap-3">
      <button onclick="openAddModal()" class="btn-primary hidden sm:flex items-center gap-2">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 5v14m7-7H5" stroke="white" stroke-width="2"/></svg>
        <span class="hidden sm:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>
      </button>
      
      <button onclick="openAddModal()" class="btn-primary sm:hidden px-3">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 5v14m7-7H5" stroke="white" stroke-width="2"/></svg>
      </button>
      <div class="flex items-center gap-2">
        <button id="headerTypeTHBtn" class="dd-btn px-3" onclick="chooseType('TH')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
        <button id="headerTypeLAOBtn" class="dd-btn px-3" onclick="chooseType('LAO')">üá±üá¶ ‡∏•‡∏≤‡∏ß</button>
        <button id="headerTypeHANOIBtn" class="dd-btn px-3" onclick="chooseType('HANOI')">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</button>
      </div>
      
    </div>
  </div>

  <!-- AI AURA CARD -->
  <div id="auraSection" class="max-w-6xl mx-auto px-4 mt-3 sm:mt-4">
    <div class="aura-card p-4 sm:p-6 mt-3 sm:mt-4">
      <h2 class="text-base sm:text-lg font-bold text-white mb-3">üåü ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á AI ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ</h2>
      <div class="text-center text-white/80 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <span id="aiScore_center">‚Äî%</span></div>

      <div id="aiLoading" class="hidden text-center my-4 sm:my-6">
        <div class="ai-spinner"></div>
        <p class="text-white/60 mt-2 text-xs sm:text-sm">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î!...</p>
      </div>
      <div id="aiWarning" class="hidden text-center my-4 sm:my-6">
        <p id="aiWarningText" class="text-white/80 text-sm sm:text-base"></p>
      </div>

      <div id="aiResult" class="ai-result-grid grid gap-3 sm:gap-4 text-white">
        <div class="card">
          <div id="aiCard1Title" class="text-xs sm:text-sm muted">üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</div>
          <div id="aiSix" class="text-xl sm:text-2xl font-bold mt-1">‚Äî</div>
        </div>

        <div class="card">
          <div id="aiCard2Title" class="text-xs sm:text-sm muted">üéØ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</div>
          <div id="aiTop3" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
        </div>

        <div class="card">
          <div id="aiCard3Title" class="text-xs sm:text-sm muted">üé≤ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß</div>
          <div id="aiBottom3" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
        </div>

        <div class="card">
          <div id="aiCard4Title" class="text-xs sm:text-sm muted">‚ú® ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</div>
          <div id="aiTwo" class="text-lg sm:text-xl font-semibold mt-1">‚Äî</div>
        </div>
      </div>
<button onclick="runAIwithAura()" class="btn-primary w-full mt-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
        <input id="backtestDateInput" type="date" class="input-dd w-full sm:col-span-2" />
        <button onclick="runBacktest()" class="btn-primary w-full">‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ôüéØ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
      </div>
      <div id="backtestResult" class="mt-3"></div>
    </div>
  </div>

  <!-- Landing Selection -->
  <div id="landing" class="max-w-6xl mx-auto px-4 mt-6 sm:mt-8 hidden">
    <div class="card p-6 text-center">
      <h2 class="text-lg font-bold text-white mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <button onclick="chooseType('TH')" class="btn-primary w-full py-3">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
        <button onclick="chooseType('LAO')" class="btn-primary w-full py-3">üá±üá¶ ‡∏•‡∏≤‡∏ß</button>
        <button onclick="chooseType('HANOI')" class="btn-primary w-full py-3">üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢</button>
      </div>
    </div>
  </div>

  <!-- ===============================
       MAIN CONTENT
       =============================== -->
  <main id="appMain" class="max-w-6xl mx-auto px-4 mt-6 sm:mt-8">

    <!-- STAT CARDS -->
    <section class="stat-grid grid gap-4 sm:gap-6 mb-8 sm:mb-10">

      <!-- Frequent 2 Digits -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üî• ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
        <div id="freq2" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <!-- Pie Chart -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üî• ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
        <div id="freq3" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <!-- AI Aura Summary -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-3">üîÆ ‡∏™‡∏£‡∏∏‡∏õ AI ‡πÉ‡∏´‡πâ‡∏´‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡πÜ</h3>

        <div class="text-sm text-white/70 space-y-1">
          <div id="aiSmallTitle1">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1:  
            <span id="aiSix_small" class="text-gold font-bold"></span>
          </div>
          <div id="aiSmallTitle2">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1: <span id="aiTop3_small" class="text-gold"></span></div>
          <div id="aiSmallTitle3">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß: <span id="aiBottom3_small" class="text-gold"></span></div>
          <div id="aiSmallTitle4">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: <span id="aiTwo_small" class="text-gold"></span></div>
          <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <span id="aiScore_small" class="text-gold font-bold"></span></div>
        </div>
      </div>

    </section>


    <!-- ===============================
         RESULT HISTORY
         =============================== -->
    <section class="card mb-10">
      <div class="flex justify-between items-center mb-4">

        <div>
          <h2 class="text-xl font-bold text-white">üóÇÔ∏è ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
          <div class="text-xs text-white/60">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        </div>

        <div class="flex items-center gap-2">
          <select id="yearFilter" class="input-dd" onchange="setYearFilter(this.value)"></select>
        </div>

      </div>

      <!-- History List -->
      <div id="historyList" class="result-grid grid gap-3 sm:gap-4"></div>
    </section>



    

  </main>
  <footer class="max-w-6xl mx-auto px-4 mt-8 mb-6 text-center text-white/60 text-xs">copyright @ 2025</footer>
<script>


/* ============================

   Firebase config & init

   ============================ */

const firebaseConfig = {

  apiKey:"AIzaSyCkS6eu3SuB5McIkS_7J8srMIhXQ7osc-E",

  authDomain:"huaymaen-lottoai.firebaseapp.com",

  databaseURL:"https://huaymaen-lottoai-default-rtdb.asia-southeast1.firebasedatabase.app",

  projectId:"huaymaen-lottoai",

  storageBucket:"huaymaen-lottoai.firebasestorage.app",

  messagingSenderId:"326340239586",

  appId:"1:326340239586:web:563d03ca906ca4ba327ebb",

  measurementId:"G-MF97ZM968E"

};

firebase.initializeApp(firebaseConfig);

const db = firebase.database().ref("lottery");


/* ============================

   Load data from Firebase

   ============================ */

db.on('value', (snap) => {

  allData = [];

  if(snap.val()){

    Object.values(snap.val()).forEach(r => allData.push(r));

    allData.sort((a,b)=> b.date.localeCompare(a.date));

  }

  populateYearFilter();
  renderHistory();

  updateStats();

});


/* ============================

   Global state

   ============================ */

let allData = [];
let historyFilter = 'all';
let yearFilter = 'all';
let pieChart = null;
let aiPressCount = 0;
let recentAi = { TH:{prize1:[], top3:[], bottom3:[], bottom2:[]}, LAO:{prize1:[], top3:[], bottom3:[], bottom2:[]}, HANOI:{prize1:[], top3:[], bottom3:[], bottom2:[]} };

let addType = 'TH';
function setAddType(t){
  addType = t;
  const ids = {TH:'typeTHBtn', LAO:'typeLAOBtn', HANOI:'typeHANOIBtn'};
  ['typeTHBtn','typeLAOBtn','typeHANOIBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove('btn-primary'); el.classList.add('dd-btn'); }
  });
  const el = document.getElementById(ids[t]);
  if(el){ el.classList.remove('dd-btn'); el.classList.add('btn-primary'); }
  const secTH = document.getElementById('addSectionTH');
  const secLAO = document.getElementById('addSectionLAO');
  const secHN = document.getElementById('addSectionHANOI');
  if(secTH) secTH.classList.add('hidden');
  if(secLAO) secLAO.classList.add('hidden');
  if(secHN) secHN.classList.add('hidden');
  if(t==='TH' && secTH) secTH.classList.remove('hidden');
  if(t==='LAO' && secLAO) secLAO.classList.remove('hidden');
  if(t==='HANOI' && secHN) secHN.classList.remove('hidden');
}
function typeToLabel(t){
  if(t==='TH') return '‡πÑ‡∏ó‡∏¢';
  if(t==='LAO') return '‡∏•‡∏≤‡∏ß';
  if(t==='HANOI') return '‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢';
  return t;
}
function normalizeType(t){
  const s = String(t||'').trim();
  if(s==='‡πÑ‡∏ó‡∏¢' || s==='TH') return 'TH';
  if(s==='‡∏•‡∏≤‡∏ß' || s==='LAO') return 'LAO';
  if(s==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢' || s==='HANOI') return 'HANOI';
  return s;
}

function setYearFilter(y){
  yearFilter = y || 'all';
  renderHistory();
}

function populateYearFilter(){
  const sel = document.getElementById('yearFilter');
  if(!sel) return;
  const years = Array.from(new Set(allData.map(r=>String(r.date||'').slice(0,4)))).filter(Boolean).sort((a,b)=> b.localeCompare(a));
  const current = yearFilter;
  const opts = ['<option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>'].concat(years.map(y=>`<option value="${y}">${y}</option>`)).join('');
  sel.innerHTML = opts;
  sel.value = current || 'all';
}

/* ======= small utils ======= */
const pad = (s,n=2)=>String(s||'').padStart(n,'0');
const isDigits = s => /^\d+$/.test(String(s||''));
function pickTemp(base=1.18){ const inc = Math.min(0.5, aiPressCount*0.04); return base + inc; }
function mixDigits(s,len,spice=0){ let d = String(s||'').padStart(len,'0').slice(-len).split(''); if(Math.random() < 0.3+spice){ const i=Math.floor(Math.random()*len); d[i]=String((parseInt(d[i],10)+1)%10); } if(Math.random() < 0.2+spice){ const i=Math.floor(Math.random()*len); const j=Math.floor(Math.random()*len); if(i!==j){ [d[i],d[j]]=[d[j],d[i]]; } } if(Math.random() < 0.15+spice){ d.push(d.shift()); } return d.join(''); }
function mixBlock3(s, spice=0){ s = String(s||'').padStart(3,'0').slice(-3); let d=s.split(''); if(Math.random() < 0.33+spice) { const i=Math.floor(Math.random()*3); d[i]=String((parseInt(d[i],10)+1)%10); } if(Math.random() < 0.22+spice) { [d[0],d[1],d[2]] = [d[1],d[2],d[0]]; } if(Math.random() < 0.18+spice) { const i=Math.floor(Math.random()*3); const j=(i+1)%3; [d[i], d[j]]=[d[j], d[i]]; } return d.join(''); }
function mixBlock2(s, spice=0){ s=String(s||'').padStart(2,'0').slice(-2); let d=s.split(''); if(Math.random() < 0.38+spice) { const i=Math.floor(Math.random()*2); d[i]=String((parseInt(d[i],10)+1)%10); } if(Math.random() < 0.18+spice) { d.reverse(); } return d.join(''); }
function mixPrize1(f,l, spice=0){ let d=(String(f||'').padStart(3,'0').slice(-3) + String(l||'').padStart(3,'0').slice(-3)).split(''); if(Math.random() < 0.28+spice) { const i=Math.floor(Math.random()*6); d[i]=String((parseInt(d[i],10)+Math.floor(Math.random()*3))%10); } if(Math.random() < 0.16+spice) { const a=Math.floor(Math.random()*6), b=Math.floor(Math.random()*6); [d[a],d[b]]=[d[b],d[a]]; } if(Math.random() < 0.12+spice){ d=[d[3],d[4],d[5],d[0],d[1],d[2]]; } return d.join(''); }
function addRecent(t,key,vals){ const store = recentAi[t]; if(!store) return; const v = Array.isArray(vals)? vals.join('|') : String(vals||''); store[key].unshift(v); if(store[key].length>6) store[key].pop(); }
function isRecent(t,key,vals){ const store = recentAi[t]; if(!store) return false; const v = Array.isArray(vals)? vals.join('|') : String(vals||''); return store[key].includes(v); }
function diversifyPick(m,k=8,temperature=1.15,avoidList=[]){ const entries = Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,k); if(entries.length===0) return ''; let weights = entries.map(([n,w])=>[n,Math.pow(w,1/temperature)]); weights = weights.filter(([n])=> !avoidList.includes(n)); if(weights.length===0) weights = entries.map(([n])=>[n,1]); const total = weights.reduce((s,[,w])=>s+w,0); let r = Math.random()*total; for(const [n,w] of weights){ r-=w; if(r<=0) return n; } return weights[0][0]; }
function sampleUniqueAvoid(m,count=3,k=8,avoidSet=[]){ const res=[]; const tmp={...m}; let guard=0; while(res.length<count && guard<200){ const p = diversifyPick(tmp,k,pickTemp(1.12),avoidSet); if(!p) break; if(!res.includes(p)){ res.push(p); delete tmp[p]; } guard++; } return res; }

/* ============================
   ONBOARDING (open once)
   ============================ */
function openOnboard(){ document.getElementById('onboard').classList.remove('hidden'); }
function closeOnboard(){
  document.getElementById('onboard').classList.add('hidden');
  localStorage.setItem('lg_onboard_done','yes');
  showLanding();
}
(function maybeOpenOnboard(){
  setTimeout(openOnboard, 700);
})();

function showLanding(){
  const ld = document.getElementById('landing'); if(ld) ld.classList.remove('hidden');
  const aura = document.getElementById('auraSection'); if(aura) aura.classList.add('hidden');
  const main = document.getElementById('appMain'); if(main) main.classList.add('hidden');
}
function hideLanding(){
  const ld = document.getElementById('landing'); if(ld) ld.classList.add('hidden');
  const aura = document.getElementById('auraSection'); if(aura) aura.classList.remove('hidden');
  const main = document.getElementById('appMain'); if(main) main.classList.remove('hidden');
}
function updateAIViewForType(t){
  const t1 = document.getElementById('aiCard1Title');
  const t2 = document.getElementById('aiCard2Title');
  const t3 = document.getElementById('aiCard3Title');
  const t4 = document.getElementById('aiCard4Title');
  const s1 = document.getElementById('aiSmallTitle1');
  const s2 = document.getElementById('aiSmallTitle2');
  const s3 = document.getElementById('aiSmallTitle3');
  const s4 = document.getElementById('aiSmallTitle4');
  if(t==='TH'){
    if(t1) t1.innerText = 'üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1';
    if(t2) t2.innerText = 'üéØ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1';
    if(t3) t3.innerText = 'üé≤ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß';
    if(t4) t4.innerText = '‚ú® ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß';
    if(s1) s1.firstChild.nodeValue = '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1:  ';
    if(s2) s2.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1: ';
    if(s3) s3.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß: ';
    if(s4) s4.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: ';
  } else if(t==='LAO'){
    if(t1) t1.innerText = 'üèÜ ‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß (x1)';
    if(t2) t2.innerText = 'üî¢ ‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß (x2)';
    if(t3) t3.innerText = 'üéØ ‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß (x3)';
    if(t4) t4.innerText = 'üß© ‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5)';
    if(s1) s1.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß:  ';
    if(s2) s2.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß (x2): ';
    if(s3) s3.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß (x3): ';
    if(s4) s4.firstChild.nodeValue = '‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5): ';
  } else if(t==='HANOI'){
    if(t1) t1.innerText = 'üèÜ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (5 ‡∏´‡∏•‡∏±‡∏Å)';
    if(t2) t2.innerText = 'üéØ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3)';
    if(t3) t3.innerText = 'üé≤ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4)';
    if(t4) t4.innerText = '‚ú® ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à';
    if(s1) s1.firstChild.nodeValue = '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (5 ‡∏´‡∏•‡∏±‡∏Å):  ';
    if(s2) s2.firstChild.nodeValue = '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3): ';
    if(s3) s3.firstChild.nodeValue = '‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4): ';
    if(s4) s4.firstChild.nodeValue = '‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: ';
  }
}
function clearAIViews(){
  const ids = ['aiSix','aiTop3','aiBottom3','aiTwo','aiScore','aiSix_small','aiTop3_small','aiBottom3_small','aiTwo_small','aiScore_small'];
  ids.forEach(id=>{ const el = document.getElementById(id); if(el){ el.innerText = (id.includes('Score')?'‚Äî%':'‚Äî'); } });
  const cs = document.getElementById('aiScore_center'); if(cs) cs.innerText = '‚Äî%';
  const load = document.getElementById('aiLoading'); if(load) load.classList.add('hidden');
  const warn = document.getElementById('aiWarning'); if(warn) warn.classList.add('hidden');
  const res = document.getElementById('aiResult'); if(res) res.classList.add('hidden');
}
function chooseType(t){
  hideLanding();
  historyFilter = t;
  setAddType(t);
  updateAIViewForType(t);
  clearAIViews();
  setHeaderTypeActive(t);
  aiPressCount = 0;
  renderHistory();
  updateStats();
}
function setHeaderTypeActive(t){
  const ids = {TH:'headerTypeTHBtn', LAO:'headerTypeLAOBtn', HANOI:'headerTypeHANOIBtn'};
  ['headerTypeTHBtn','headerTypeLAOBtn','headerTypeHANOIBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.classList.remove('btn-primary'); el.classList.add('dd-btn'); }
  });
  const el = document.getElementById(ids[t]);
  if(el){ el.classList.remove('dd-btn'); el.classList.add('btn-primary'); }
}

/* ============================
   ADD RESULT MODAL controls
   ============================ */
function openAddModal(){
  document.getElementById('addModal').classList.remove('hidden');
  const t = (historyFilter && historyFilter!=='all') ? historyFilter : addType;
  setAddType(t);
}
function openEditModal(d, t){
  document.getElementById('addModal').classList.remove('hidden');
  const ttl = document.getElementById('addModalTitle'); if(ttl) ttl.innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
  let tt = normalizeType(t);
  setAddType(tt);
  const candidates = allData.filter(x=> String(x.date)===String(d) && normalizeType(x.type)===tt);
  let r = null;
  if(candidates.length>0){
    const is3 = s => /^\d{3}$/.test(String(s||''));
    const is2 = s => /^\d{2}$/.test(String(s||''));
    const is4 = s => /^\d{4}$/.test(String(s||''));
    const is5 = s => /^\d{5}$/.test(String(s||''));
    let best = null; let bestScore = -1;
    candidates.forEach(o=>{
      const score = (String(o.full6||'').length===6?1:0)
        + (is3(o.lower3a)?1:0) + (is3(o.lower3b)?1:0) + (is2(o.bottom)?1:0)
        + (is4(o.last4)?1:0) + (is3(o.last3)?1:0)
        + ((String(o.last2_multi||'').split(',').map(x=>x.trim()).filter(x=>is2(x)).length>0)?1:0)
        + (is5(o.first5)?1:0)
        + ((String(o.prize6_list||'').split(',').map(x=>x.trim()).filter(x=>is3(x)).length>=3)?1:0)
        + ((String(o.prize7_list||'').split(',').map(x=>x.trim()).filter(x=>is2(x)).length>=4)?1:0);
      if(score>bestScore){ bestScore=score; best=o; }
    });
    r = best;
  }
  const di = document.getElementById('dateInput'); if(di) di.value = `${String(d).slice(0,4)}-${String(d).slice(4,6)}-${String(d).slice(6,8)}`;
  if(r){
    if(tt==='TH'){
      const a = document.getElementById('firstPrizeInput'); if(a) a.value = r.full6||'';
      const b = document.getElementById('threeBottomAInput'); if(b) b.value = r.lower3a||'';
      const c = document.getElementById('threeBottomBInput'); if(c) c.value = r.lower3b||'';
      const d2 = document.getElementById('twoBottomInput'); if(d2) d2.value = r.bottom||'';
    } else if(tt==='LAO'){
      const a = document.getElementById('laoSixInput'); if(a) a.value = r.six||'';
      const b = document.getElementById('laoLast4Input'); if(b) b.value = r.last4||'';
      const c = document.getElementById('laoLast3Input'); if(c) c.value = r.last3|| (r.last4?String(r.last4).slice(1):'');
      const d3 = document.getElementById('laoLast2MultiInput'); if(d3) d3.value = r.last2_multi||'';
    } else if(tt==='HANOI'){
      const a = document.getElementById('hnFirst5Input'); if(a) a.value = r.first5||'';
      const b = document.getElementById('hnPrize6Input'); if(b) b.value = r.prize6_list||'';
      const c = document.getElementById('hnPrize7Input'); if(c) c.value = r.prize7_list||'';
      const d2 = document.getElementById('hnTwoBottomInput'); if(d2) d2.value = r.bottom||'';
    }
  }
}
function closeAddModal(){
  document.getElementById('addModal').classList.add('hidden');
  const ttl = document.getElementById('addModalTitle'); if(ttl) ttl.innerText = 'üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà';
  // clear fields
  const ids = ['dateInput','firstPrizeInput','threeBottomAInput','threeBottomBInput','twoBottomInput','laoSixInput','laoLast4Input','laoLast3Input','laoLast2MultiInput','hnFirst5Input','hnPrize6Input','hnPrize7Input','hnTwoBottomInput'];
  ids.forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
  setAddType('TH');
}

async function deleteResult(d, t){
  const tt = normalizeType(t);
  const typeLabel = typeToLabel(tt);
  const dateFmt = `${String(d).slice(6,8)}/${String(d).slice(4,6)}/${String(d).slice(0,4)}`;
  const ok = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateFmt}`);
  if(!ok) return;
  try {
    await db.child(String(d)).remove();
  } catch (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Firebase.');
  }
}

/* ============================
   Header dropdown (flag)
   ============================ */
function toggleDD(){
  const menu = document.getElementById('ddMenu');
  if(menu) menu.classList.toggle('hidden');
}
function setDD(label, flag){
  const lbl = document.getElementById('ddLabel');
  const f = document.getElementById('ddFlag');
  if(lbl) lbl.innerText = label;
  if(f) f.innerText = flag;
  // no immediate filtering required here (this is visual header)
  // close menu
  const menu = document.getElementById('ddMenu'); if(menu) menu.classList.add('hidden');
}

 



/* ============================
   Helper: check duplicate by date+type
   ============================ */
function hasDuplicate(dateStr, typeStr){
  return allData.some(r => String(r.date) === String(dateStr) && String(r.type) === String(typeStr));
}

/* ============================
   Save result from Add Modal
   - validate fields
   - prevent duplicate date+type
   - push to firebase
   - clear & close
   - trigger AI run + effects
   ============================ */
async function saveResult(){
  const dateVal = (document.getElementById('dateInput').value||'').trim();
  if(!dateVal){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }
  const dnum = dateVal.replace(/-/g,'');
  const type = addType;

  let payload = { date: dnum, type };
  const typeLabel = typeToLabel(type);
  let confirmMsg = '';

  if(type==='TH'){
    const full6 = (document.getElementById('firstPrizeInput').value||'').trim();
    const threeA = (document.getElementById('threeBottomAInput').value||'').trim();
    const threeB = (document.getElementById('threeBottomBInput').value||'').trim();
    const two = (document.getElementById('twoBottomInput').value||'').trim();
    const full6Clean = (isDigits(full6) && full6.length===6) ? pad(full6,6) : '';
    const twoClean = (isDigits(two) && two.length===2) ? pad(two,2) : '';
    let bottomA='---', bottomB='---';
    if(isDigits(threeA) && threeA.length===3) bottomA = threeA;
    if(isDigits(threeB) && threeB.length===3) bottomB = threeB;
    payload = { ...payload, full6: full6Clean, lower3a: bottomA, lower3b: bottomB, bottom: twoClean };
    confirmMsg = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateVal}\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1: ${full6Clean||'‚Äî'}\n‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß: ${bottomA}, ${bottomB==='---'?'‚Äî':bottomB}\n‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: ${twoClean||'‚Äî'}`;
  } else if(type==='LAO'){
    const lao6 = (document.getElementById('laoSixInput')?.value||'').trim();
    const lao4 = (document.getElementById('laoLast4Input')?.value||'').trim();
    const lao3 = (document.getElementById('laoLast3Input')?.value||'').trim();
    const lao2m = (document.getElementById('laoLast2MultiInput')?.value||'').trim();
    const clean6 = s=> (isDigits(s)&&s.length===6 ? s : '');
    const clean4 = s=> (isDigits(s)&&s.length===4 ? s : '');
    const clean3 = s=> (isDigits(s)&&s.length===3 ? s : '');
    const list2 = s=> (s? s.split(',').map(x=>x.trim()).filter(x=>isDigits(x)&&x.length===2) : []);
    const s6 = clean6(lao6);
    const l4 = clean4(lao4);
    let l3 = clean3(lao3);
    if(!l3 && l4) l3 = l4.slice(1);
    const l2m = list2(lao2m);
    if(!s6 && !l4 && !l3 && l2m.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß'); return; }
    const devDisplay = l2m.join(', ');
    payload = { ...payload, six: s6, last4: l4, last3: l3, last2_multi: devDisplay, bottom: devDisplay };
    confirmMsg = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateVal}\n‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß: ${s6||'‚Äî'}\n‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß: ${l4||'‚Äî'}\n‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß: ${l3|| (l4?l4.slice(1):'‚Äî')}\n‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5): ${devDisplay||'‚Äî'}`;
  } else if(type==='HANOI'){
    const hn5 = (document.getElementById('hnFirst5Input')?.value||'').trim();
    const hn6 = (document.getElementById('hnPrize6Input')?.value||'').trim();
    const hn7 = (document.getElementById('hnPrize7Input')?.value||'').trim();
    const hn2 = (document.getElementById('hnTwoBottomInput')?.value||'').trim();
    const clean5 = s=> (isDigits(s)&&s.length===5 ? s : '');
    const list3 = s=> (s? s.split(',').map(x=>x.trim()).filter(x=>isDigits(x)&&x.length===3) : []);
    const list2 = s=> (s? s.split(',').map(x=>x.trim()).filter(x=>isDigits(x)&&x.length===2) : []);
    const f5 = clean5(hn5);
    const p6 = list3(hn6);
    const p7 = list2(hn7);
    const b2 = (isDigits(hn2) && hn2.length===2) ? pad(hn2,2) : '';
    if(!f5 && p6.length===0 && p7.length===0 && !b2){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ß‡∏¢‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'); return; }
    const bottomDisplay = b2 || (p7.length>0 ? p7.join(', ') : '');
    payload = { ...payload, first5: f5, prize6_list: p6.join(', '), prize7_list: p7.join(', '), bottom: bottomDisplay };
    confirmMsg = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateVal}\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (5 ‡∏´‡∏•‡∏±‡∏Å): ${f5||'‚Äî'}\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3): ${p6.join(', ')||'‚Äî'}\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4): ${p7.join(', ')||'‚Äî'}\n‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß: ${bottomDisplay||'‚Äî'}`;
  }

  const ok = confirm(confirmMsg);
  if(!ok) return;
  try {
    const key = `${dnum}`;
    await db.child(key).set(payload);
    closeAddModal();
  } catch (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Firebase.');
  }
}



/* ============================
   Firebase listener -> keep allData up-to-date
   ============================ */
// handled above (single listener)

/* ============================
   Render history (cards)
   - respect historyFilter
   - latest 12 entries
   ============================ */
function renderHistory(){
  const box = document.getElementById('historyList');
  if(!box) return;
  
  let arr = allData.slice();

  const is3 = s => /^\d{3}$/.test(String(s||''));
  const is2 = s => /^\d{2}$/.test(String(s||''));
  const is4 = s => /^\d{4}$/.test(String(s||''));
  const is5 = s => /^\d{5}$/.test(String(s||''));

  const byKey = new Map();
  arr.forEach(r => {
    const key = r.date + '|' + normalizeType(r.type);
    const score = (String(r.full6||'').length===6?1:0)
      + (is3(r.lower3a)?1:0) + (is3(r.lower3b)?1:0) + (is2(r.bottom)?1:0)
      + (is4(r.last4)?1:0) + (is3(r.last3)?1:0) + (is2(r.last2)?1:0)
      + ((String(r.last2_multi||'').split(',').map(x=>x.trim()).filter(x=>is2(x)).length>0)?1:0)
      + (is5(r.first5)?1:0)
      + ((String(r.prize6_list||'').split(',').map(x=>x.trim()).filter(x=>is3(x)).length>=3)?1:0)
      + ((String(r.prize7_list||'').split(',').map(x=>x.trim()).filter(x=>is2(x)).length>=4)?1:0);
    const exist = byKey.get(key);
    if(!exist || score > exist._score) { r._score = score; byKey.set(key, r); }
  });
  arr = Array.from(byKey.values());
  arr.sort((a,b)=> b.date.localeCompare(a.date));

  if(historyFilter && historyFilter !== 'all'){
    arr = arr.filter(r => {
      const t = String(r.type).trim();
      if(historyFilter==='TH') return t==='TH' || t==='‡πÑ‡∏ó‡∏¢';
      if(historyFilter==='LAO') return t==='LAO' || t==='‡∏•‡∏≤‡∏ß';
      if(historyFilter==='HANOI') return t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢';
      return true;
    });
  }

  if(yearFilter && yearFilter !== 'all'){
    arr = arr.filter(r => String(r.date||'').slice(0,4) === yearFilter);
  }

  if(arr.length === 0){
    box.innerHTML = `<div class="text-white/60 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    return;
  }

  const cardTH = (r, flag, typeLabel, dateFmt) => {
    const top3 = (r.full6 && r.full6.length === 6) ? r.full6.slice(-3) : '‚Äî';
    const a = (/^\d{3}$/.test(String(r.lower3a||''))) ? r.lower3a : '‚Äî';
    const b = (/^\d{3}$/.test(String(r.lower3b||''))) ? r.lower3b : '‚Äî';
    const lower = `${a}, ${b}`;
    return `
      <div class="result-card p-4" data-date="${r.date}" data-type="${r.type}" data-full6="${r.full6||''}" data-lower3a="${r.lower3a||''}" data-lower3b="${r.lower3b||''}" data-bottom="${r.bottom||''}">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm text-white/70">${flag} <span class="font-semibold ml-1">${typeLabel}</span></div>
          <div class="flex items-center gap-2">
            <div class="text-xs text-yellow-300">üìÖ ${dateFmt}</div>
            <button onclick="openEditModal('${r.date}','${r.type}')" class="text-blue-300 text-xs">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="deleteResult('${r.date}','${r.type}')" class="text-red-300 text-xs">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="text-2xl font-extrabold mb-2">üèÜ ${r.full6||'‚Äî'}</div>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1</div>
            <div class="font-bold text-green-300">${top3}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-green-300">${lower}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-pink-300">${r.bottom||'‚Äî'}</div>
          </div>
        </div>
      </div>`;
  };

  const cardLAO = (r, flag, typeLabel, dateFmt) => {
    const l2m = String(r.last2_multi||'').split(',').map(x=>x.trim()).filter(Boolean).join(', ');
    const last3Show = r.last3 || (r.last4?String(r.last4).slice(1):'‚Äî');
    return `
      <div class="result-card p-4" data-date="${r.date}" data-type="${r.type}" data-six="${r.six||''}" data-last4="${r.last4||''}" data-last3="${r.last3||''}" data-last2multi="${r.last2_multi||''}">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm text-white/70">${flag} <span class="font-semibold ml-1">${typeLabel}</span></div>
          <div class="flex items-center gap-2">
            <div class="text-xs text-yellow-300">üìÖ ${dateFmt}</div>
            <button onclick="openEditModal('${r.date}','${r.type}')" class="text-blue-300 text-xs">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="deleteResult('${r.date}','${r.type}')" class="text-red-300 text-xs">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="text-2xl font-extrabold mb-2">üèÜ ${r.six||r.last4||'‚Äî'}</div>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-green-300">${r.last4||'‚Äî'}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-green-300">${last3Show}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5)</div>
            <div class="font-bold text-pink-300">${l2m||'‚Äî'}</div>
          </div>
        </div>
      </div>`;
  };

  const cardHN = (r, flag, typeLabel, dateFmt) => {
    const p6 = String(r.prize6_list||'').split(',').map(x=>x.trim()).filter(Boolean).join(', ');
    const p7 = String(r.prize7_list||'').split(',').map(x=>x.trim()).filter(Boolean).join(', ');
    return `
      <div class="result-card p-4" data-date="${r.date}" data-type="${r.type}" data-first5="${r.first5||''}" data-prize6="${r.prize6_list||''}" data-prize7="${r.prize7_list||''}" data-bottom="${r.bottom||''}">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm text-white/70">${flag} <span class="font-semibold ml-1">${typeLabel}</span></div>
          <div class="flex items-center gap-2">
            <div class="text-xs text-yellow-300">üìÖ ${dateFmt}</div>
            <button onclick="openEditModal('${r.date}','${r.type}')" class="text-blue-300 text-xs">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="deleteResult('${r.date}','${r.type}')" class="text-red-300 text-xs">‡∏•‡∏ö</button>
          </div>
        </div>
        <div class="text-2xl font-extrabold mb-2">üèÜ ${r.first5||'‚Äî'}</div>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="text-center">
            <div class="text-xs text-white/60">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3)</div>
            <div class="font-bold text-green-300">${p6||'‚Äî'}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4)</div>
            <div class="font-bold text-green-300">${p7||'‚Äî'}</div>
          </div>
          <div class="text-center">
            <div class="text-xs text-white/60">‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß</div>
            <div class="font-bold text-pink-300">${r.bottom||'‚Äî'}</div>
          </div>
        </div>
      </div>`;
  };

  box.innerHTML = arr.map(r => {
    const flag = (r.type === 'TH' || r.type==='‡πÑ‡∏ó‡∏¢') ? 'üáπüá≠'
      : (r.type==='LAO' || r.type==='‡∏•‡∏≤‡∏ß') ? 'üá±üá¶'
      : (r.type==='HANOI' || r.type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') ? 'üáªüá≥' : 'üåê';
    const typeLabel = r.type === 'TH' ? '‡πÑ‡∏ó‡∏¢' : r.type === 'LAO' ? '‡∏•‡∏≤‡∏ß' : r.type === 'HANOI' ? '‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢' : r.type;
    const dateFmt = `${r.date.slice(6,8)}/${r.date.slice(4,6)}/${r.date.slice(0,4)}`;
    const t = String(r.type).trim();
    if(t==='LAO' || t==='‡∏•‡∏≤‡∏ß') return cardLAO(r, flag, typeLabel, dateFmt);
    if(t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') return cardHN(r, flag, typeLabel, dateFmt);
    return cardTH(r, flag, typeLabel, dateFmt);
  }).join('');
}

/* ============================
   Update stats: pie chart + freq2
   ============================ */
function updateStats(){
  const arr = allData.filter(r=>{
    if(historyFilter==='all' || !historyFilter) return true;
    const t = String(r.type).trim();
    if(historyFilter==='TH') return t==='TH' || t==='‡πÑ‡∏ó‡∏¢';
    if(historyFilter==='LAO') return t==='LAO' || t==='‡∏•‡∏≤‡∏ß';
    if(historyFilter==='HANOI') return t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢';
    return true;
  });

  const freq2 = {};
  arr.forEach(r=>{
    const t = String(r.type||'').trim();
    if(t==='TH' || t==='‡πÑ‡∏ó‡∏¢'){
      const b = String(r.bottom||'').trim();
      if(/^\d{2}$/.test(b)) freq2[b] = (freq2[b]||0) + 1;
    } else if(t==='LAO' || t==='‡∏•‡∏≤‡∏ß'){
      const dev = String(r.last2_multi||'').split(',').map(x=>x.trim()).filter(x=>/^\d{2}$/.test(x));
      dev.forEach(n=>{ freq2[n] = (freq2[n]||0) + 1; });
    } else if(t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'){
      const p7 = String(r.prize7_list||'').split(',').map(x=>x.trim()).filter(x=>/^\d{2}$/.test(x));
      p7.forEach(n=>{ freq2[n] = (freq2[n]||0) + 1; });
    } else {
      const parts = String(r.bottom||'').split(',').map(x=>x.trim()).filter(x=>/^\d{2}$/.test(x));
      parts.forEach(n=>{ freq2[n] = (freq2[n]||0) + 1; });
    }
  });
  const top10_2 = Object.entries(freq2).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([n])=>n);
  const el2 = document.getElementById('freq2');
  if(el2) el2.innerHTML = top10_2.map(n=>`<div class="text-white badge-sm">${n}</div>`).join(' ');

  const freq3 = {};
  arr.forEach(r=>{
    const t = String(r.type||'').trim();
    if(t==='TH' || t==='‡πÑ‡∏ó‡∏¢'){
      const a = String(r.lower3a||'').trim();
      const b = String(r.lower3b||'').trim();
      if(/^\d{3}$/.test(a)) freq3[a] = (freq3[a]||0) + 1;
      if(/^\d{3}$/.test(b)) freq3[b] = (freq3[b]||0) + 1;
    } else if(t==='LAO' || t==='‡∏•‡∏≤‡∏ß'){
      let l3 = String(r.last3||'').trim();
      if(!/^\d{3}$/.test(l3) && /^\d{4}$/.test(String(r.last4||'').trim())) l3 = String(r.last4).slice(1);
      if(/^\d{3}$/.test(l3)) freq3[l3] = (freq3[l3]||0) + 1;
    } else if(t==='HANOI' || t==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'){
      const p6 = String(r.prize6_list||'').split(',').map(x=>x.trim()).filter(x=>/^\d{3}$/.test(x));
      p6.forEach(n=>{ freq3[n] = (freq3[n]||0) + 1; });
    }
  });
  const top10_3 = Object.entries(freq3).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([n])=>n);
  const el3 = document.getElementById('freq3');
  if(el3) el3.innerHTML = top10_3.map(n=>`<div class="text-white badge-sm">${n}</div>`).join(' ');
}

/* ============================
   RUN AI WITH AURA (UI flow)
   - show spinner, then compute
   ============================ */
function runAIwithAura(){
  const load = document.getElementById('aiLoading');
  const result = document.getElementById('aiResult');
  const warn = document.getElementById('aiWarning');
  if(load) load.classList.remove('hidden');
  if(result) result.classList.add('hidden');
  if(warn) warn.classList.add('hidden');

  // give the aura animation time
  aiPressCount++;
  setTimeout(()=>{
    runAICalc();
    // small aura flash
    auraFlash();
  }, 900);
}

/* ============================
   Collect dataset from History table (visible entries)
   ============================ */
function getTableData(){
  const cards = Array.from(document.querySelectorAll('#historyList .result-card'));
  const clean3 = s => { const v = String(s||'').trim(); return (/^\d{3}$/.test(v) ? v : ''); };
  const clean2 = s => { const v = String(s||'').trim(); return (/^\d{2}$/.test(v) ? v : ''); };
  const clean4 = s => { const v = String(s||'').trim(); return (/^\d{4}$/.test(v) ? v : ''); };
  const clean5 = s => { const v = String(s||'').trim(); return (/^\d{5}$/.test(v) ? v : ''); };
  const clean6 = s => { const v = String(s||'').trim(); return (/^\d{6}$/.test(v) ? v : ''); };
  const toList = (s,len) => (String(s||'').split(',').map(x=>x.trim()).filter(x=>x.length===len && /^\d+$/.test(x)));
  return cards.map(card=>({
    date: card.getAttribute('data-date')||'',
    type: card.getAttribute('data-type')||'TH',
    full6: clean6(card.getAttribute('data-full6')),
    lower3a: clean3(card.getAttribute('data-lower3a')),
    lower3b: clean3(card.getAttribute('data-lower3b')),
    bottom: clean2(card.getAttribute('data-bottom')),
    six: clean6(card.getAttribute('data-six')),
    last4: clean4(card.getAttribute('data-last4')),
    last3: clean3(card.getAttribute('data-last3')),
    last2: clean2(card.getAttribute('data-last2')),
    last2multi: toList(card.getAttribute('data-last2multi'),2),
    first5: clean5(card.getAttribute('data-first5')),
    prize6list: toList(card.getAttribute('data-prize6'),3),
    prize7list: toList(card.getAttribute('data-prize7'),2)
  }));
}

/* ============================
   Core AI calculation (from history table)
   ============================ */
function Ai() {
  const tableData = getTableData();
  if(tableData.length === 0) {
    const type = historyFilter;
    const icon = type==='LAO' ? 'üá±üá¶‚ö†Ô∏è' : type==='HANOI' ? 'üáªüá≥‚ö†Ô∏è' : 'üáπüá≠‚ö†Ô∏è';
    const msg = `${icon} ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Ai ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡πÜ‡πÉ‡∏´‡πâ ‡∏Ñ‡∏£‡∏±‡∏ö`;
    return { insufficient: true, warning: msg, prize1: '‚Äî‚Äî', top3: ['‚Äî', '‚Äî', '‚Äî'], bottom3: ['‚Äî', '‚Äî', '‚Äî'], bottom2: ['‚Äî', '‚Äî', '‚Äî'], confidence: 0 };
  }

  const type = historyFilter;
  const arrFull = tableData.map(r=>r.full6).filter(Boolean);
  const f3Arr = arrFull.map(s=> s.slice(0,3));
  const l3Arr = arrFull.map(s=> s.slice(3));

  const is3 = s => /^\d{3}$/.test(String(s||''));
  const is2 = s => /^\d{2}$/.test(String(s||''));
  const lowerArr = [];
  tableData.forEach(r=>{
    if(is3(r.lower3a)) lowerArr.push(r.lower3a);
    if(is3(r.lower3b)) lowerArr.push(r.lower3b);
  });
  const bottomArr = tableData.map(r=>r.bottom).filter(v=>is2(v));
  const lao6Arr = tableData.map(r=>r.six).filter(v=>/^\d{6}$/.test(String(v||'')));
  const lao4Arr = tableData.map(r=>r.last4).filter(v=>/^\d{4}$/.test(String(v||'')));
  const lao3Arr = [];
  tableData.forEach(r=>{
    if(is3(r.last3)) lao3Arr.push(r.last3);
    if(/^\d{4}$/.test(String(r.last4||''))){ const x = String(r.last4).slice(1); if(is3(x)) lao3Arr.push(x); }
  });
  const lao2mArr = []; tableData.forEach(r=> (r.last2multi||[]).forEach(x=>{ if(is2(x)) lao2mArr.push(x); }));
  const hn5Arr = tableData.map(r=>r.first5).filter(v=>/^\d{5}$/.test(String(v||'')));
  const hn6Arr = []; tableData.forEach(r=> (r.prize6list||[]).forEach(x=>{ if(is3(x)) hn6Arr.push(x); }));
  const hn7Arr = []; tableData.forEach(r=> (r.prize7list||[]).forEach(x=>{ if(is2(x)) hn7Arr.push(x); }));

  // weighted frequency function (decay by index)
  const weightedFreq = (arr, decay=0.045) => {
    const m = {};
    arr.forEach((v,i)=>{
      m[v] = (m[v]||0) + Math.exp(-decay * i);
    });
    return m;
  };

  const topN = (m, n=3) => Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
  const weightedPick = (m, k=5) => {
    const entries = Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,k);
    const total = entries.reduce((s, [,w])=> s + w, 0);
    if(entries.length === 0) return '';
    if(total <= 0) return entries[0][0];
    let r = Math.random() * total;
    for(const [key, w] of entries){ r -= w; if(r <= 0) return key; }
    return entries[0][0];
  };
  const sampleUnique = (m, count=3, k=5) => {
    const res = [];
    const tmp = {...m};
    for(let i=0; i<count; i++){
      const p = weightedPick(tmp, k);
      if(!p) break;
      res.push(p);
      delete tmp[p];
    }
    return res;
  };

  const mapF = weightedFreq(f3Arr, 0.045);
  const mapL = weightedFreq(l3Arr, 0.045);

  // small delta-ish scoring: prefer repeated runs
  const deltaScore = (arr) => {
    const s = {};
    arr.forEach((v,i)=>{
      const next = arr[i+1];
      if(next && v===next) s[v]=(s[v]||0)+0.25;
      else s[v]=(s[v]||0)+0.05;
    });
    return s;
  };

  const deltaF = deltaScore(f3Arr);
  const deltaL = deltaScore(l3Arr);

  // combine maps: weight freq + delta
  const combine = (freqMap, deltaMap) => {
    const merged = {};
    Object.keys(freqMap).forEach(k => merged[k] = (merged[k]||0) + freqMap[k]*0.7 + (deltaMap[k]||0)*0.4);
    Object.keys(deltaMap).forEach(k => { if(!merged[k]) merged[k] = (deltaMap[k]||0)*0.4; });
    return merged;
  };

  const combF = combine(mapF, deltaF);
  const combL = combine(mapL, deltaL);

  const lowerMap = weightedFreq(lowerArr, 0.05);
  const bottomMap = weightedFreq(bottomArr, 0.06);

  if(type==='LAO' || type==='‡∏•‡∏≤‡∏ß'){
    const noData = lao6Arr.length===0 && lao4Arr.length===0 && lao3Arr.length===0 && lao2mArr.length===0;
    if(noData){
      const msg = `üá±üá¶‚ö†Ô∏è ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Ai ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡πÜ‡πÉ‡∏´‡πâ ‡∏Ñ‡∏£‡∏±‡∏ö`;
      return { insufficient: true, warning: msg, prize1: '‚Äî‚Äî', top3: ['‚Äî','‚Äî'], bottom3: ['‚Äî','‚Äî','‚Äî'], bottom2: ['‚Äî','‚Äî','‚Äî','‚Äî','‚Äî'], confidence: 0 };
    }
    const lao6Map = weightedFreq(lao6Arr, 0.042);
    const lao4Map = weightedFreq(lao4Arr, 0.042);
    const lao3Map = weightedFreq(lao3Arr, 0.052);
    const lao2mMap = weightedFreq(lao2mArr, 0.062);

    let six1 = Object.keys(lao6Map).length ? diversifyPick(lao6Map, 10, pickTemp(1.18), []) : '';
    if(!six1){
      const base3 = Object.keys(lao3Map).length ? diversifyPick(lao3Map, 8, pickTemp(1.2), []) : '';
      const rand3 = String(Math.floor(Math.random()*1000)).padStart(3,'0');
      six1 = (base3+rand3) || '‚Äî‚Äî';
    }
    if(/^\d{6}$/.test(String(six1||''))) { six1 = mixDigits(six1, 6, 0.08); }

    const set4 = sampleUniqueAvoid(lao4Map, 2, 10, []);
    while(set4.length<2){
      const fb4 = Object.entries(lao4Map).sort((a,b)=>b[1]-a[1]).map(([k])=>k);
      for(const x of fb4){ if(set4.length>=2) break; if(!set4.includes(x)) set4.push(x); }
      if(set4.length<2) set4.push('‚Äî');
    }
    for(let i=0;i<set4.length;i++){ if(/^\d{4}$/.test(String(set4[i]||''))) set4[i] = mixDigits(set4[i],4,0.06); }

    const set3 = sampleUniqueAvoid(lao3Map, 3, 10, []);
    while(set3.length<3){
      const fb3 = Object.entries(lao3Map).sort((a,b)=>b[1]-a[1]).map(([k])=>k);
      for(const x of fb3){ if(set3.length>=3) break; if(!set3.includes(x)) set3.push(x); }
      if(set3.length<3) set3.push('‚Äî');
    }
    for(let i=0;i<set3.length;i++){ if(/^\d{3}$/.test(String(set3[i]||''))) set3[i] = mixBlock3(set3[i],0.06); }

    const dev5 = sampleUniqueAvoid(lao2mMap, 5, 10, []);
    let guard = 0;
    while(dev5.length<5 && guard<50){
      const pick = diversifyPick(lao2mMap, 10, pickTemp(1.15), []) || '';
      if(pick){ if(!dev5.includes(pick)) dev5.push(pick); }
      else dev5.push('‚Äî');
      guard++;
    }
    while(dev5.length<5) dev5.push('‚Äî');
    for(let i=0;i<dev5.length;i++){ if(/^\d{2}$/.test(String(dev5[i]||''))) dev5[i] = mixBlock2(dev5[i],0.06); }

    const conf = Math.min(95, Math.max(60, Math.round(56 + (Object.keys(lao6Map).length+Object.keys(lao4Map).length+Object.keys(lao3Map).length)*1.7 + (Math.random()-0.4)*14)));
    addRecent('LAO','prize1', six1||''); addRecent('LAO','top3', set4); addRecent('LAO','bottom3', set3); addRecent('LAO','bottom2', dev5);
    return { prize1:six1, top3:set4, bottom3:set3, bottom2:dev5, confidence: conf };
  }

  if(type==='HANOI' || type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'){
    const noData = hn5Arr.length===0 && hn6Arr.length===0 && hn7Arr.length===0;
    if(noData){
      const msg = `üáªüá≥‚ö†Ô∏è ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Ai ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡πÜ‡πÉ‡∏´‡πâ ‡∏Ñ‡∏£‡∏±‡∏ö`;
      return { insufficient: true, warning: msg, prize1: '‚Äî‚Äî', top3: ['‚Äî','‚Äî','‚Äî'], bottom3: ['‚Äî','‚Äî','‚Äî','‚Äî'], bottom2: ['‚Äî'], confidence: 0 };
    }
    const hn5Map = weightedFreq(hn5Arr, 0.042);
    const hn6Map = weightedFreq(hn6Arr, 0.052);
    const hn7Map = weightedFreq(hn7Arr, 0.062);
    const first5_raw = Object.keys(hn5Map).length? diversifyPick(hn5Map, 8, pickTemp(1.18), []) : '‚Äî';
    let first5 = first5_raw;
    if(/^\d{5}$/.test(String(first5||''))) { first5 = mixDigits(first5,5,0.08); }
    const p6 = sampleUniqueAvoid(hn6Map, 3, 9, []); while(p6.length<3) p6.push('‚Äî');
    for(let i=0;i<p6.length;i++){ if(/^\d{3}$/.test(String(p6[i]||''))) p6[i] = mixBlock3(p6[i],0.06); }
    const p7 = sampleUniqueAvoid(hn7Map, 4, 9, []); while(p7.length<4) p7.push('‚Äî');
    for(let i=0;i<p7.length;i++){ if(/^\d{2}$/.test(String(p7[i]||''))) p7[i] = mixBlock2(p7[i],0.06); }
    const conf = Math.min(95, Math.max(60, Math.round(56 + (Object.keys(hn6Map).length+Object.keys(hn7Map).length)*1.7 + (Math.random()-0.4)*14)));
    addRecent('HANOI','prize1', first5||''); addRecent('HANOI','top3', p6); addRecent('HANOI','bottom3', p7); addRecent('HANOI','bottom2', ['‚Äî']);
    return { prize1:first5, top3:p6, bottom3:p7, bottom2:['‚Äî'], confidence: conf };
  }

  const insufficientTH = arrFull.length===0;
  if(insufficientTH){
    const msg = `üáπüá≠‚ö†Ô∏è ‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Ai ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡πÜ‡πÉ‡∏´‡πâ ‡∏Ñ‡∏£‡∏±‡∏ö`;
    return { insufficient: true, warning: msg, prize1: '‚Äî‚Äî', top3: ['‚Äî','‚Äî','‚Äî'], bottom3: ['‚Äî','‚Äî','‚Äî'], bottom2: ['‚Äî','‚Äî','‚Äî'], confidence: 0 };
  }
  let bestF = diversifyPick(combF, 10, pickTemp(1.2), [] ) || '000';
  let bestL = diversifyPick(combL, 10, pickTemp(1.2), [] ) || '000';
  let prize1 = mixPrize1(bestF, bestL, 0.08);
  let tguard = 0;
  while(isRecent('TH','prize1', prize1) && tguard<5){ bestF = diversifyPick(combF, 10, pickTemp(1.25), [] ) || bestF; bestL = diversifyPick(combL, 10, pickTemp(1.25), [] ) || bestL; prize1 = mixPrize1(bestF, bestL, 0.08); tguard++; }
  if(Math.random() < 0.33){ const d = prize1.split(''); const pos = Math.floor(Math.random()*6); d[pos] = String(Math.floor(Math.random()*10)); prize1 = d.join(''); }
  if(Math.random() < 0.12){ const n = parseInt(prize1,10) || 0; prize1 = String((n + 1 + Math.floor(Math.random()*97)) % 1000000).padStart(6,'0'); }
  if(Math.random() < 0.03){ const n = parseInt(prize1,10) || 0; prize1 = String((n + Math.floor(Math.random()*37)) % 1000000).padStart(6,'0'); }
  const bottom3 = sampleUniqueAvoid(lowerMap, 3, 9, []);
  if(bottom3.length < 3){ const fb = Object.entries(lowerMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb){ if(bottom3.length>=3) break; if(!bottom3.includes(x)) bottom3.push(x); } }
  while(bottom3.length < 3) bottom3.push('‚Äî');
  const bottom2 = sampleUniqueAvoid(bottomMap, 3, 9, []);
  if(bottom2.length < 3){ const fb2 = Object.entries(bottomMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb2){ if(bottom2.length>=3) break; if(!bottom2.includes(x)) bottom2.push(x); } }
  while(bottom2.length < 3) bottom2.push('‚Äî');
  const top3 = sampleUniqueAvoid(combL, 3, 8, []);

  // confidence: based on gap between top and second for f3 and l3
  const calcConf = (map) => {
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    if(entries.length < 2) return 68;
    const diff = entries[0][1] - entries[1][1];
    const s = Math.min(95, Math.max(68, Math.round(58 + diff * 28)));
    return s;
  };
  let confidence = Math.round((calcConf(mapF) + calcConf(mapL)) / 2);
  const jitter = Math.round((Math.random() - 0.4) * 14);
  confidence = Math.min(95, Math.max(68, confidence + jitter));
  addRecent('TH','prize1', prize1); addRecent('TH','top3', top3); addRecent('TH','bottom3', bottom3); addRecent('TH','bottom2', bottom2);
  return { prize1, top3, bottom3, bottom2, confidence };
}

function runAICalc(){
  const results = Ai();

  if(results.insufficient){
    const warn = document.getElementById('aiWarning');
    const txt = document.getElementById('aiWarningText');
    const res = document.getElementById('aiResult');
    if(res) res.classList.add('hidden');
    if(warn) warn.classList.remove('hidden');
    if(txt) txt.innerText = results.warning || '';
  } else {
    document.getElementById('aiSix') && (document.getElementById('aiSix').innerText = results.prize1 || '‚Äî');
    document.getElementById('aiTop3') && (document.getElementById('aiTop3').innerText = results.top3.join(', ') || '‚Äî');
    document.getElementById('aiBottom3') && (document.getElementById('aiBottom3').innerText = results.bottom3.join(', ') || '‚Äî');
    document.getElementById('aiTwo') && (document.getElementById('aiTwo').innerText = results.bottom2.join(', ') || '‚Äî');
    document.getElementById('aiScore') && (document.getElementById('aiScore').innerText = results.confidence + '%' || '‚Äî%');
  }

  if(document.getElementById('aiSix_small')) document.getElementById('aiSix_small').innerText = results.prize1 || '‚Äî';
  if(document.getElementById('aiTop3_small')) document.getElementById('aiTop3_small').innerText = results.top3.join(', ') || '‚Äî';
  if(document.getElementById('aiBottom3_small')) document.getElementById('aiBottom3_small').innerText = results.bottom3.join(', ') || '‚Äî';
  if(document.getElementById('aiTwo_small')) document.getElementById('aiTwo_small').innerText = results.bottom2.join(', ') || '‚Äî';
  if(document.getElementById('aiScore_small')) document.getElementById('aiScore_small').innerText = results.confidence + '%' || '‚Äî%';
  if(document.getElementById('aiScore_center')) document.getElementById('aiScore_center').innerText = results.confidence + '%' || '‚Äî%';

  const load = document.getElementById('aiLoading'); if(load) load.classList.add('hidden');
  const res2 = document.getElementById('aiResult');
  const warn2 = document.getElementById('aiWarning');
  if(!results.insufficient){ if(res2) res2.classList.remove('hidden'); if(warn2) warn2.classList.add('hidden'); }
}
function AiFromRecords(records, type){
  const is3 = s => /^\d{3}$/.test(String(s||''));
  const is2 = s => /^\d{2}$/.test(String(s||''));
  const is4 = s => /^\d{4}$/.test(String(s||''));
  const is5 = s => /^\d{5}$/.test(String(s||''));
  const arrFull = records.map(r=>String(r.full6||'')).filter(s=>/^\d{6}$/.test(s));
  const f3Arr = arrFull.map(s=> s.slice(0,3));
  const l3Arr = arrFull.map(s=> s.slice(3));
  const lowerArr = [];
  records.forEach(r=>{ if(is3(r.lower3a)) lowerArr.push(r.lower3a); if(is3(r.lower3b)) lowerArr.push(r.lower3b); });
  const bottomArr = records.map(r=>r.bottom).filter(v=>is2(v));
  const lao6Arr = records.map(r=>r.six).filter(v=>/^\d{6}$/.test(String(v||'')));
  const lao4Arr = records.map(r=>r.last4).filter(v=>is4(v));
  const lao3Arr = [];
  records.forEach(r=>{ if(is3(r.last3)) lao3Arr.push(r.last3); if(is4(r.last4)){ const x = String(r.last4).slice(1); if(is3(x)) lao3Arr.push(x); } });
  const lao2mArr = [];
  records.forEach(r=> String(r.last2_multi||'').split(',').map(x=>x.trim()).forEach(x=>{ if(is2(x)) lao2mArr.push(x); }));
  const hn5Arr = records.map(r=>r.first5).filter(v=>is5(v));
  const hn6Arr = [];
  records.forEach(r=> String(r.prize6_list||'').split(',').map(x=>x.trim()).forEach(x=>{ if(is3(x)) hn6Arr.push(x); }));
  const hn7Arr = [];
  records.forEach(r=> String(r.prize7_list||'').split(',').map(x=>x.trim()).forEach(x=>{ if(is2(x)) hn7Arr.push(x); }));

  const weightedFreq = (arr, decay=0.045) => { const m={}; arr.forEach((v,i)=>{ m[v]=(m[v]||0)+Math.exp(-decay*i); }); return m; };
  const weightedPick = (m, k=5) => { const entries=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,k); const total=entries.reduce((s,[,w])=>s+w,0); if(entries.length===0) return ''; if(total<=0) return entries[0][0]; let r=Math.random()*total; for(const [key,w] of entries){ r-=w; if(r<=0) return key; } return entries[0][0]; };
  const sampleUnique = (m, count=3, k=5) => { const res=[]; const tmp={...m}; for(let i=0;i<count;i++){ const p=weightedPick(tmp,k); if(!p) break; res.push(p); delete tmp[p]; } return res; };
  const deltaScore = (arr) => { const s={}; arr.forEach((v,i)=>{ const next=arr[i+1]; if(next&&v===next) s[v]=(s[v]||0)+0.25; else s[v]=(s[v]||0)+0.05; }); return s; };
  const combine = (freqMap, deltaMap) => { const merged={}; Object.keys(freqMap).forEach(k=> merged[k]=(merged[k]||0)+freqMap[k]*0.7+(deltaMap[k]||0)*0.4); Object.keys(deltaMap).forEach(k=>{ if(!merged[k]) merged[k]=(deltaMap[k]||0)*0.4; }); return merged; };

  if(type==='LAO' || type==='‡∏•‡∏≤‡∏ß'){
    const noData = lao6Arr.length===0 && lao4Arr.length===0 && lao3Arr.length===0 && lao2mArr.length===0;
    if(noData){ return { insufficient:true, warning:'', prize1:'‚Äî‚Äî', top3:['‚Äî','‚Äî'], bottom3:['‚Äî','‚Äî','‚Äî'], bottom2:['‚Äî','‚Äî','‚Äî','‚Äî','‚Äî'], confidence:0 }; }
    const lao6Map = weightedFreq(lao6Arr, 0.04);
    const lao4Map = weightedFreq(lao4Arr, 0.04);
    const lao3Map = weightedFreq(lao3Arr, 0.05);
    const lao2mMap = weightedFreq(lao2mArr, 0.06);
    let six1 = Object.keys(lao6Map).length ? weightedPick(lao6Map, 10) : '';
    if(!six1){ const base3 = Object.keys(lao3Map).length ? Object.entries(lao3Map).sort((a,b)=>b[1]-a[1])[0][0] : ''; const rand3 = String(Math.floor(Math.random()*1000)).padStart(3,'0'); six1 = (base3+rand3) || '‚Äî‚Äî'; }
    const set4 = sampleUnique(lao4Map, 2, 10); while(set4.length<2){ const fb4 = Object.entries(lao4Map).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb4){ if(set4.length>=2) break; if(!set4.includes(x)) set4.push(x); } if(set4.length<2) set4.push('‚Äî'); }
    const set3 = sampleUnique(lao3Map, 3, 10); while(set3.length<3){ const fb3 = Object.entries(lao3Map).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb3){ if(set3.length>=3) break; if(!set3.includes(x)) set3.push(x); } if(set3.length<3) set3.push('‚Äî'); }
    const dev5 = sampleUnique(lao2mMap, 5, 10); let guard=0; while(dev5.length<5 && guard<50){ const pick=weightedPick(lao2mMap,10)||''; if(pick){ if(!dev5.includes(pick)) dev5.push(pick); } else dev5.push('‚Äî'); guard++; } while(dev5.length<5) dev5.push('‚Äî');
    const conf = Math.min(96, Math.max(35, Math.round(50 + (Object.keys(lao6Map).length+Object.keys(lao4Map).length+Object.keys(lao3Map).length)*1.5 + (Math.random()-0.5)*12)));
    return { prize1:six1, top3:set4, bottom3:set3, bottom2:dev5, confidence: conf };
  }
  if(type==='HANOI' || type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢'){
    const noData = hn5Arr.length===0 && hn6Arr.length===0 && hn7Arr.length===0;
    if(noData){ return { insufficient:true, warning:'', prize1:'‚Äî‚Äî', top3:['‚Äî','‚Äî','‚Äî'], bottom3:['‚Äî','‚Äî','‚Äî','‚Äî'], bottom2:['‚Äî'], confidence:0 }; }
    const hn5Map = weightedFreq(hn5Arr, 0.04);
    const hn6Map = weightedFreq(hn6Arr, 0.05);
    const hn7Map = weightedFreq(hn7Arr, 0.06);
    const first5 = Object.keys(hn5Map).length? Object.entries(hn5Map).sort((a,b)=>b[1]-a[1])[0][0] : '‚Äî';
    const p6 = sampleUnique(hn6Map, 3, 8); while(p6.length<3) p6.push('‚Äî');
    const p7 = sampleUnique(hn7Map, 4, 8); while(p7.length<4) p7.push('‚Äî');
    const conf = Math.min(96, Math.max(35, Math.round(50 + (Object.keys(hn6Map).length+Object.keys(hn7Map).length)*1.5 + (Math.random()-0.5)*12)));
    return { prize1:first5, top3:p6, bottom3:p7, bottom2:['‚Äî'], confidence: conf };
  }
  const insufficientTH = arrFull.length===0;
  if(insufficientTH){ return { insufficient:true, warning:'', prize1:'‚Äî‚Äî', top3:['‚Äî','‚Äî','‚Äî'], bottom3:['‚Äî','‚Äî','‚Äî'], bottom2:['‚Äî','‚Äî','‚Äî'], confidence:0 }; }
  const mapF = weightedFreq(f3Arr, 0.045);
  const mapL = weightedFreq(l3Arr, 0.045);
  const deltaF = deltaScore(f3Arr);
  const deltaL = deltaScore(l3Arr);
  const combF = combine(mapF, deltaF);
  const combL = combine(mapL, deltaL);
  const lowerMap = weightedFreq(lowerArr, 0.05);
  const bottomMap = weightedFreq(bottomArr, 0.06);
  let bestF = weightedPick(combF, 8) || '000';
  let bestL = weightedPick(combL, 8) || '000';
  let prize1 = (bestF + bestL);
  if(Math.random() < 0.35){ const d = prize1.split(''); const pos = Math.floor(Math.random()*6); d[pos] = String(Math.floor(Math.random()*10)); prize1 = d.join(''); }
  if(Math.random() < 0.15){ const n = parseInt(prize1,10) || 0; prize1 = String((n + 1 + Math.floor(Math.random()*97)) % 1000000).padStart(6,'0'); }
  if(Math.random() < 0.02){ const n = parseInt(prize1,10) || 0; prize1 = String((n + Math.floor(Math.random()*37)) % 1000000).padStart(6,'0'); }
  const bottom3 = sampleUnique(lowerMap, 3, 8); if(bottom3.length < 3){ const fb = Object.entries(lowerMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb){ if(bottom3.length>=3) break; if(!bottom3.includes(x)) bottom3.push(x); } } while(bottom3.length < 3) bottom3.push('‚Äî');
  const bottom2 = sampleUnique(bottomMap, 3, 8); if(bottom2.length < 3){ const fb2 = Object.entries(bottomMap).sort((a,b)=>b[1]-a[1]).map(([k])=>k); for(const x of fb2){ if(bottom2.length>=3) break; if(!bottom2.includes(x)) bottom2.push(x); } } while(bottom2.length < 3) bottom2.push('‚Äî');
  const top3 = sampleUnique(combL, 3, 5);
  const calcConf = (map) => { const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]); if(entries.length < 2) return 60; const diff = entries[0][1] - entries[1][1]; const s = Math.min(96, Math.max(35, Math.round(50 + diff * 30))); return s; };
  let confidence = Math.round((calcConf(mapF) + calcConf(mapL)) / 2);
  const jitter = Math.round((Math.random() - 0.5) * 12);
  confidence = Math.min(96, Math.max(35, confidence + jitter));
  return { prize1, top3, bottom3, bottom2, confidence };
}

function runBacktest(){
  const el = document.getElementById('backtestDateInput');
  const out = document.getElementById('backtestResult');
  if(!el || !out) return;
  const v = (el.value||'').trim();
  if(!v){ out.innerHTML = '<div class="text-white/70">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>'; return; }
  const d = v.replace(/-/g,'');
  const tSel = historyFilter;
  const foundAny = allData.find(r=> String(r.date)===d && (
    tSel==='TH' ? (r.type==='TH' || r.type==='‡πÑ‡∏ó‡∏¢') :
    tSel==='LAO' ? (r.type==='LAO' || r.type==='‡∏•‡∏≤‡∏ß') :
    tSel==='HANOI' ? (r.type==='HANOI' || r.type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') : true
  ));
  if(!foundAny){ out.innerHTML = '<div class="text-white/70">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏öüòú</div>'; return; }
  const norm = (x)=>{ const s = String(x||'').trim(); if(s==='TH' || s==='‡πÑ‡∏ó‡∏¢') return 'TH'; if(s==='LAO' || s==='‡∏•‡∏≤‡∏ß') return 'LAO'; if(s==='HANOI' || s==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') return 'HANOI'; return 'TH'; };
  const t = (tSel==='TH' || tSel==='LAO' || tSel==='HANOI') ? tSel : norm(foundAny.type);
  const found = allData.find(r=> String(r.date)===d && (
    t==='TH' ? (r.type==='TH' || r.type==='‡πÑ‡∏ó‡∏¢') :
    t==='LAO' ? (r.type==='LAO' || r.type==='‡∏•‡∏≤‡∏ß') :
    t==='HANOI' ? (r.type==='HANOI' || r.type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') : true
  )) || foundAny;
  const hist = allData.filter(r=> String(r.date) < d && (
    t==='TH' ? (r.type==='TH' || r.type==='‡πÑ‡∏ó‡∏¢') :
    t==='LAO' ? (r.type==='LAO' || r.type==='‡∏•‡∏≤‡∏ß') :
    t==='HANOI' ? (r.type==='HANOI' || r.type==='‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢') : true
  ));
  const results = AiFromRecords(hist, t);
  const showArr = arr => (arr||[]).filter(Boolean).join(', ');
  let gen1 = results.prize1||'‚Äî';
  let real1 = '‚Äî';
  let genTop = showArr(results.top3);
  let realTop = '‚Äî';
  let genBottom3 = showArr(results.bottom3);
  let realBottom3 = '‚Äî';
  let genBottom2 = showArr(results.bottom2);
  let realBottom2 = '‚Äî';
  if(t==='TH'){
    real1 = String(found.full6||'').trim() || '‚Äî';
    const f6 = String(found.full6||'').trim();
    realTop = (/^\d{6}$/.test(f6)) ? f6.slice(-3) : '‚Äî';
    realBottom3 = [found.lower3a, found.lower3b].filter(x=>/^\d{3}$/.test(String(x||''))).join(', ') || '‚Äî';
    realBottom2 = String(found.bottom||'').trim() || '‚Äî';
  } else if(t==='LAO'){
    real1 = String(found.six||found.last4||'').trim() || '‚Äî';
    realTop = String(found.last4||'').trim() || '‚Äî';
    realBottom3 = String(found.last3|| (found.last4?String(found.last4).slice(1):'') ).trim() || '‚Äî';
    realBottom2 = String(found.last2_multi||'').trim() || '‚Äî';
  } else if(t==='HANOI'){
    real1 = String(found.first5||'').trim() || '‚Äî';
    realTop = String(found.prize6_list||'').trim() || '‚Äî';
    realBottom3 = String(found.prize7_list||'').trim() || '‚Äî';
    realBottom2 = '‚Äî';
  }
  if(real1==='‚Äî' && realTop==='‚Äî' && realBottom3==='‚Äî' && realBottom2==='‚Äî'){
    if(t==='TH'){
      const el = document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="TH"]`) || document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="‡πÑ‡∏ó‡∏¢"]`);
      if(el){
        const f6 = el.getAttribute('data-full6')||'';
        const l3a = el.getAttribute('data-lower3a')||'';
        const l3b = el.getAttribute('data-lower3b')||'';
        const b2 = el.getAttribute('data-bottom')||'';
        real1 = f6||'‚Äî';
        realTop = (/^\d{6}$/.test(String(f6))) ? String(f6).slice(-3) : '‚Äî';
        const arr3 = [l3a,l3b].filter(x=>/^\d{3}$/.test(String(x||'')));
        realBottom3 = arr3.join(', ') || '‚Äî';
        realBottom2 = (/^\d{2}$/.test(String(b2||''))) ? String(b2) : '‚Äî';
      }
    } else if(t==='LAO'){
      const el = document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="LAO"]`) || document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="‡∏•‡∏≤‡∏ß"]`);
      if(el){
        const six = el.getAttribute('data-six')||'';
        const last4 = el.getAttribute('data-last4')||'';
        const last3 = el.getAttribute('data-last3')||'';
        const l2m = el.getAttribute('data-last2multi')||'';
        real1 = (six||last4)||'‚Äî';
        realTop = last4||'‚Äî';
        realBottom3 = (last3 || (last4? String(last4).slice(1): '')) || '‚Äî';
        realBottom2 = l2m||'‚Äî';
      }
    } else if(t==='HANOI'){
      const el = document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="HANOI"]`) || document.querySelector(`#historyList .result-card[data-date="${d}"][data-type="‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢"]`);
      if(el){
        const f5 = el.getAttribute('data-first5')||'';
        const p6 = el.getAttribute('data-prize6')||'';
        const p7 = el.getAttribute('data-prize7')||'';
        const b2 = el.getAttribute('data-bottom')||'';
        real1 = f5||'‚Äî';
        realTop = p6||'‚Äî';
        realBottom3 = p7||'‚Äî';
        realBottom2 = b2||'‚Äî';
      }
    }
  }
  let labelTop = 'üéØ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1';
  let labelB3 = 'üé≤ ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß';
  let labelB2 = '‚ú® ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß';
  if(t==='LAO'){
    labelTop = 'üéØ ‡πÄ‡∏•‡∏Ç 4 ‡∏ï‡∏±‡∏ß (x2)';
    labelB3 = 'üé≤ ‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß (x3)';
    labelB2 = '‚ú® ‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤ (2 ‡∏´‡∏•‡∏±‡∏Å x5)';
  } else if(t==='HANOI'){
    labelTop = 'üéØ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 6 (3 ‡∏´‡∏•‡∏±‡∏Å x3)';
    labelB3 = 'üé≤ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 7 (2 ‡∏´‡∏•‡∏±‡∏Å x4)';
    labelB2 = '‚ú® ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß';
  }
  const score = (results.confidence||0)+'%';
  const typeLabel = (t==='TH') ? 'üáπüá≠ ‡πÑ‡∏ó‡∏¢' : (t==='LAO') ? 'üá±üá¶ ‡∏•‡∏≤‡∏ß' : (t==='HANOI') ? 'üáªüá≥ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢' : String(t);
  out.innerHTML = `
    <div class="card p-3">
      <div class="text-white/80 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${v} ‚Ä¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeLabel}</div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2 text-sm">
        <div class="text-white/80"><div class="muted">‡∏ú‡∏• AI</div>
          <div>üèÜ ${gen1}</div>
          <div>${labelTop}: ${genTop||'‚Äî'}</div>
          <div>${labelB3}: ${genBottom3||'‚Äî'}</div>
          <div>${labelB2}: ${genBottom2||'‚Äî'}</div>
          <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${score}</div>
        </div>
        <div class="text-white/80"><div class="muted">‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á</div>
          <div>üèÜ ${real1}</div>
          <div>${labelTop}: ${realTop||'‚Äî'}</div>
          <div>${labelB3}: ${realBottom3||'‚Äî'}</div>
          <div>${labelB2}: ${realBottom2||'‚Äî'}</div>
        </div>
      </div>
    </div>`;
}

/* ============================
   Aura flash (temporary highlight)
   ============================ */
function auraFlash(){
  const el = document.querySelector('.aura-card');
  if(!el) return;
  const prev = el.style.boxShadow;
  el.style.boxShadow = '0 0 70px rgba(250,200,100,0.85)';
  setTimeout(()=>{ el.style.boxShadow = prev; }, 900);
}

/* ============================
   Small helper: run on load to compute initial AI
   ============================ */
function tryInitialAI(){
  // manual-only: do not auto-run AI after data load
}
// no auto-trigger; user clicks the button to run AI

/* ============================
   Utility: manual trigger for testing
   ============================ */
window.runAIwithAura = runAIwithAura;
window.runAICalc = runAICalc;

/* ============================
   Small UX: close dropdowns when clicking outside
   ============================ */
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.dd-btn') && !e.target.closest('.dd-menu')) {
    const m = document.getElementById('ddMenu'); if(m) m.classList.add('hidden');
  }
});

/* ============================
   End of script
   ============================ */
</script>


